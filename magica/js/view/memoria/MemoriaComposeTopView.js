define("underscore backbone backboneCommon ajaxControl memoriaUtil command text!template/memoria/MemoriaComposeTop.html js/view/memoria/MemoriaComposeTopCardListView js/view/memoria/MemoriaComposeTopStatusView js/view/memoria/MemoriaComposeTopTargetView js/view/memoria/MemoriaComposeTopUseMaterialView".split(" "),function(f,h,a,m,e,k,v,l,p,q,n){var g=!1,r=h.Model.extend(),w=h.View.extend({events:function(){var b={};b[a.cgti+" #runBtn"]=this.composeRunFunc;b[a.cgti+" .wrapClose"]=this.wrapCloseFunc;
b[a.cgti+" #ascPanelMemoria li"]=this.ascBtn;return b},initialize:function(){this.listenTo(this,"remove",this.removeView);this.template=f.template(v);g=!1;this.tapCount=0;this.createDom()},render:function(){var b=m.getPageJson();b.composeMode=a.composeMode+"Mode";this.$el.html(this.template(b));return this},createDom:function(){a.content.append(this.render().el);this.createView()},createView:function(){t.prototype.rootView=this;new t;u.prototype.rootView=this;new u;this.setViewFlag="none";this.composeArray=
{};this.materialPieceId=[];q.prototype.rootView=this;p.prototype.rootView=this;l.prototype.rootView=this;l.prototype.memoriaUtil=e;n.prototype.rootView=this;n.prototype.memoriaUtil=e;this.targetView=new q({model:new r,el:a.doc.getElementById("targetCard")});this.statusView=new p({model:new r,el:a.doc.getElementById("statusWrap")});this.useMaterialView=new n({el:a.doc.getElementById("useItem")});this.cardListView=new l({el:a.doc.getElementById("cardListWrap")});"compose"===a.composeMode&&this.targetView.model.toJSON().level===
this.targetView.model.toJSON().maxLevel&&a.backLinkHandler();"limitbreak"===a.composeMode&&3<this.targetView.model.toJSON().lbCount&&a.backLinkHandler();a.setGlobalView();k.getBaseData(a.getNativeObj());a.ready.hide();a.addClass(a.doc.getElementById("memoriaComposeGlowArea"),"fadeIn")},wrapCloseFunc:function(b){b.preventDefault();if(!a.isScrolled()){var c=b.currentTarget.getAttribute("data-wrap-id");c&&(a.ready.show(),"material"==this.setViewFlag?(a.memoriaMaterialChange?(this.useMaterialView.selectItemUpdate(),
a.memoriaMaterialChange=!1):(this.trigger("proveReset"),a.scrollRefresh("scrollMain","scrollInner"),this.useMaterialView.proveMaterial=[]),"limitbreak"===a.composeMode?(4>this.useMaterialView.selectMaterial.length&&a.removeClass(a.doc.getElementById("cardWrap"),"reachMaxLevel"),this.cardListView.limitBreakDisplayHandler()):this.cardListView.composeDisplayHandler(),this.costRicheUpdate("backFlg")):0<this.useMaterialView.selectMaterial.length&&this.costRicheUpdate("backFlg"),setTimeout(function(){a.doc.getElementById("globalBackBtn").getAttribute("data-noLink")&&
(a.doc.getElementById("globalBackBtn").removeAttribute("data-noLink"),a.doc.getElementById("globalBackBtn").removeAttribute("data-wrap-id"));a.removeClass(a.doc.getElementById("cardListWrap"),"material");a.doc.getElementById("mainWrap").style.display="block";a.doc.getElementById(c).style.display="none";a.ready.hide();a.addClass(a.doc.getElementById("memoriaComposeGlowArea"),"fadeIn");a.removeClass(a.doc.getElementById("memoriaComposeGlowArea"),"off")},200));this.setViewFlag="none"}},costRiche:function(){var a=
this.useMaterialView.proveMaterial.length;if(0===a)return 0;var c=this.targetView.model.toJSON(),d=c.level,c=e.getComposeFactor(c.piece.rank);return Math.floor((49+1*d)*c)*a},costRicheUpdate:function(b){var c=this.targetView.model.toJSON(),d=c.level;e.getComposeFactor(c.piece.rank);b=b?this.useMaterialView.selectMaterial.length:this.useMaterialView.selectCount;c=e.getComposeFactor(c.piece.rank);d=Math.floor((49+1*d)*c)*b;a.doc.querySelector("#costRiche .riche").textContent=d},composeRunFunc:function(){m.getPageJson();
var b="compose"===a.composeMode?"Enhance Memoria":"Ascend Memoria";if(this.targetView.model.toJSON().id)if(this.useMaterialView.selectMaterial.length){var c=a.storage.gameUser.toJSON().riche;if(parseInt(a.doc.querySelector("#costRiche .riche").textContent,10)>c)new a.PopupClass({title:b,content:"Insufficient Curse Chips.",closeBtnText:"Close",exClass:"memoriaConfirmPop"});else{a.storage.composeTarget=this.targetView.model.toJSON();this.composeArray.baseUserPieceId=a.storage.composeTarget.id;var d=
[],e=this,h=[];this.useMaterialView.selectMaterial.some(function(a){h.push({pieceId:a.pieceId,rank:a.piece.rank});d.push(a.id);e.materialPieceId.push(a.pieceId+"")});this.composeArray.materialUserPieceIdList=d;if("compose"===a.composeMode){var c=f.template($("#ComposeDesidePopup").text()),g=f.sortBy(h,"rank").reverse(),l=!1;if(f.findWhere(g,{rank:"RANK_3"})||f.findWhere(g,{rank:"RANK_4"})||f.findWhere(g,{rank:"RANK_5"}))l=!0;c=c({rarityAlert:l,dispArr:g})}else c=f.template($("#LimitbreakDesidePopup").text()),
c=c({dispArr:h});new a.PopupClass({title:b,exClass:"memoriaConfirmPop"},c,null,function(){$("#composeRunDecideBtn").off(a.cgti);a.removeClass(a.doc.getElementById("memoriaComposePopupCurtain"),"on");a.removeClass(a.doc.getElementById("memoriaComposeGlowArea"),"on")});k.getBaseData(a.getNativeObj());a.removeClass(a.doc.getElementById("popupCurtain"),"show");a.addClass(a.doc.getElementById("memoriaComposePopupCurtain"),"on");a.addClass(a.doc.getElementById("memoriaComposeGlowArea"),"on");$("#composeRunDecideBtn").on(a.cgti,
function(b){b.preventDefault();a.isScrolled()||0<e.tapCount||(e.tapCount++,a.tapBlock(!0),$("#composeRunDecideBtn").off(a.cgti),e.composeRunAccept())})}}else new a.PopupClass({title:b,content:"No Materials Selected",closeBtnText:"Close",exClass:"memoriaConfirmPop"});else new a.PopupClass({title:b,content:"No Target is Selected",closeBtnText:"Close",exClass:"memoriaConfirmPop"})},composeRunAccept:function(){a.androidKeyStop=!0;if(!g){g=!0;var b=this;m.ajaxPost(a.linkList.userPieceCompose,this.composeArray,
function(c){k.setWebView(!1);a.tapBlock(!1);a.responseSetStorage(c);b.trigger("deleteCheck",b.useMaterialView.selectMaterial);f.each(b.useMaterialView.selectMaterial,function(b,c){b=a.storage.userPieceList.findWhere({id:b.id});a.storage.userPieceList.remove(b)});$("#commandDiv").on("nativeCallback",function(b,c){$("#commandDiv").off();k.setWebView();k.startBgm(a.bgm);setTimeout(function(){a.androidKeyStop=!1},300)});a.g_popup_instance&&a.g_popup_instance.popupView.close();k.startMemoriaAnimation({memoria:c.memoria});
b.afterComposeHandler();b.tapCount=0;a.removeClass(a.doc.getElementById("memoriaComposePopupCurtain"),"on");a.removeClass(a.doc.getElementById("memoriaComposeGlowArea"),"fadeIn");window.isBrowser&&(a.androidKeyStop=!1)})}},afterComposeHandler:function(){var b=this.targetView,c=this.statusView,d=a.storage.userPieceList.findWhere({id:b.model.id});d.set("maxLevel",e.getMaxLevel(d.toJSON().piece.rank,d.toJSON().lbCount));b.model.clear();b.model.set(d.toJSON());c.model.set(d.toJSON());c=e.getNextExp(d.toJSON().experience,
d.toJSON().level);a.doc.getElementById("info_needExp").textContent=c;this.trigger("baseUpdate",a.storage.userPieceList.findWhere({id:b.model.id}));a.memoriaComposeTarget=a.storage.userPieceList.findWhere({id:b.model.id});this.useMaterialView.useItemSelectReset();b=a.storage.gameUser.toJSON();a.doc.getElementById("info_hasRicheTop").textContent=b.riche;a.doc.getElementById("info_hasRiche").textContent=b.riche;a.doc.getElementById("info_memoriaCount").textContent=a.storage.userPieceList.length;a.removeClass(a.doc.getElementById("needExp").getElementsByClassName("lvUpIcon")[0],
"show");a.removeClass(a.doc.getElementById("getLimitBreak").getElementsByClassName("lvUpIcon")[0],"show");this.trigger("proveReset");this.useMaterialView.proveMaterial=[];k.getBaseData(a.getNativeObj());a.scrollRefresh(null,null,!0);g=!1},ascBtn:function(b){b.preventDefault();a.isScrolled()||this.trigger("ascStartMemoria",b)},removeView:function(){this.trigger("removeView");this.off();this.remove()}}),u=h.View.extend({id:"memoriaComposeGlowArea",initialize:function(){this.listenTo(this.rootView,"removeView",
this.removeView);this.template=f.template($("#glowTemplate").text());this.createDom()},render:function(){this.$el.html(this.template({gameUser:a.storage.gameUser.toJSON()}));return this},createDom:function(){a.doc.getElementById("baseContainer").appendChild(this.render().el)},removeView:function(){this.off();this.remove()}}),t=h.View.extend({id:"memoriaComposePopupCurtain",initialize:function(){this.listenTo(this.rootView,"removeView",this.removeView);this.createDom()},render:function(){this.$el.html();
return this},createDom:function(){a.doc.getElementById("baseContainer").appendChild(this.render().el)},removeView:function(){this.off();this.remove()}});return w});