define("underscore backbone backboneCommon ajaxControl text!template/memoria/UserMemoriaList.html js/view/memoria/UserMemoriaListPartsView js/view/memoria/MemoriaEquipInfoView memoriaSortUtil memoriaUtil command".split(" "),function(g,h,a,m,w,p,q,x,r,n){var k=!1,l="rank level hp atk def lb get".split(" "),t={rank:"Rarity",level:"Level",hp:"HP",atk:"ATK",def:"DEF",lb:"Ascension",get:"Date"},y=["TOWER","DAILYTOWER","BRANCH","SINGLERAID"],z=h.Model.extend(),d,A=h.View.extend({events:function(){var b=
{};b[a.cgti+" #ascPanelMemoria li"]=this.ascStartMemoria;b[a.cgti+" #sortBtn"]=this.sortStart;b[a.cgti+" #sortPopupMemoria"]=this.sortPopMemoria;b[a.cgti+" #eventFilterBtn"]=this.eventFilterBtn;b[a.cgti+" #sellResetBtn"]=this.sellReset;b[a.cgti+" #sellConfirm"]=this.sellConfirm;b[a.cgti+" #selectCommon"]=this.selectCommon;b[a.cgti+" #sizeChange"]=this.sizeChange;return b},initialize:function(b){this.template=g.template(w);this.listenTo(this,"remove",this.removeView);this.equipInfo=b.equipInfo;this.mode=
b.mode;this.memoriaSort=d=new x("UserMemoriaList_card",this);this.sellModels=[];k=!1;a.setGlobalView();this.createDom()},render:function(){this.$el.html(this.template(m.getPageJson()));return this},createDom:function(){a.content.append(this.render().el);this.growViewSet();this.cautionViewUpdate();this.createView()},growViewSet:function(){u.prototype.rootView=this;new u;v.prototype.rootView=this;new v},cautionViewUpdate:function(){var b="";switch(this.mode){case "sell":b="Select Memoria to Sell";break;
case "equip":b="Select Memoria to Equip";break;case "formationEquip":b="Select Memoria to Equip";break;case "compose":b="Select Memoria to Enhance";break;case "limitbreak":b="Select Memoria to Ascend"}a.doc.querySelector("#memoriaInfoWrap").textContent=b},createView:function(){var b=m.getPageJson();"formationEquip"==this.mode&&a.addClass(a.doc.querySelector("#menu"),"noneDisp");var c=this;this.mode&&a.addClass(a.doc.getElementById("UserMemoriaList"),this.mode);this.orderSet();d.isFilterOn()?a.doc.getElementById("sortPopupMemoria").className=
"se_tabs sb_gold_02 TE on":a.doc.getElementById("sortPopupMemoria").className="se_tabs sb_gold_02 TE off";a.doc.querySelector("#sortBtn").innerHTML="\x3cspan class\x3d'b_screen'\x3e\x3c/span\x3e"+t[d.getSortId()];a.addClass(a.doc.getElementById("memoriaWrapInner"),d.getSortId());a.scrollSet("scrollSet","scrollInner");this.eventRunning=!1;b.eventList&&g.each(b.eventList,function(b){0<=y.indexOf(b.eventType)&&(c.eventRunning=!0,a.addClass(a.doc.getElementById("eventFilterBtn"),"onDisp"),d.sortPrm[4]?
a.addClass(a.doc.getElementById("memoriaWrap"),"onlyEvent"):a.removeClass(a.doc.getElementById("memoriaWrap"),"onlyEvent"))});this.memoriaPartsTemplate=g.template($("#MemoriaListParts").text());this.memoriaUtil=r;p.prototype.parentView=this;var b=a.doc.getElementById("memoriaWrap"),f=a.doc.getElementById("sizeChange");switch(d.getDisplaySize()){case .8:a.addClass(b,"smaller");f.dataset.size="smallest";a.addClass(f,"smaller");break;case .7:a.removeClass(b,"smaller");a.addClass(b,"smallest");f.dataset.size=
"normal";a.removeClass(f,"smaller");a.addClass(f,"smallest");break;default:a.removeClass(b,"smallest"),f.dataset.size="smaller",a.removeClass(f,"smallest")}this.memoriaCount=0;this.equipMemoriaId=null;this.firstCollectionSort();this.createListView()},createListView:function(){var b=this,c=a.doc.createDocumentFragment();a.storage.userPieceList.each(function(f,e){e=f.toJSON();e.selectFlg&&f.unset("selectFlg");e.formationEquipFlag&&f.unset("formationEquipFlag");"formationEquip"==b.mode&&e.equipFlag&&
f.unset("equipFlag");"formationEquip"===b.mode&&b.equipInfo&&b.equipInfo.allPiece&&(b.equipInfo.pieceModel&&e.id===b.equipInfo.pieceModel.id&&(b.equipMemoriaId=e.id),b.equipInfo.allPiece[e.id]&&b.equipInfo.allPiece[e.id].name&&f.set({formationEquipFlag:b.equipInfo.allPiece[e.id].charaId}));f.set("maxLevel",r.getMaxLevel(e.piece.rank,e.lbCount));f=new p({model:f});c.appendChild(f.render().el);b.equipedPrimary&&e.equipFlag&&(f.el.style.WebkitOrder="-1000",f.el.style.order="-1000");b.memoriaCount++;
30===b.memoriaCount&&(a.doc.getElementById("memoriaWrapInner").appendChild(c),"lv"!==d.getSortId()&&"rank"!==d.getSortId()&&"lb"!==d.getSortId()&&b.trigger("dispChange",d.getSortId()),n.getBaseData(a.getNativeObj()),a.ready.hide(),c=null,c=a.doc.createDocumentFragment())});"lv"!==d.getSortId()&&"rank"!==d.getSortId()&&"lb"!==d.getSortId()&&this.trigger("dispChange",d.getSortId());a.doc.getElementById("info_memoriaCount").textContent=this.memoriaCount;a.doc.getElementById("memoriaWrapInner").appendChild(c);
c=null;"sell"===b.mode?b.listenTo(a.storage.userPieceList,"change",b.calcSalePrice):"equip"!==b.mode&&"formationEquip"!==b.mode||b.equipInitalize();null!==d.sortPrm[4]&&a.addClass(a.doc.getElementById("eventFilterBtn"),"on");a.scrollRefresh("scrollSet","scrollInner");30<this.memoriaCount?n.getBaseData(a.getNativeObj()):(n.getBaseData(a.getNativeObj()),a.ready.hide())},firstCollectionSort:function(){var b={RANK_1:0,RANK_2:1,RANK_3:2,RANK_4:3,RANK_5:4},c="asc"===d.sortPrm[1]?1:-1;a.storage.userPieceList.comparator=
function(a,e){if("rank"==d.sortPrm[0]){if(b[e.get("piece").rank]<b[a.get("piece").rank])return-1*c;if(b[e.get("piece").rank]>b[a.get("piece").rank])return 1*c}else if("level"==d.sortPrm[0]){if(e.get("level")<a.get("level"))return-1*c;if(e.get("level")>a.get("level"))return 1*c}else if("atk"==d.sortPrm[0]){if(e.get("attack")<a.get("attack"))return-1*c;if(e.get("attack")>a.get("attack"))return 1*c}else if("def"==d.sortPrm[0]){if(e.get("defense")<a.get("defense"))return-1*c;if(e.get("defense")>a.get("defense"))return 1*
c}else if("hp"==d.sortPrm[0]){if(e.get("hp")<a.get("hp"))return-1*c;if(e.get("hp")>a.get("hp"))return 1*c}else if("lb"==d.sortPrm[0]){if(e.get("lbCount")<a.get("lbCount"))return-1*c;if(e.get("lbCount")>a.get("lbCount"))return 1*c}if("get"!==d.sortPrm[0]){if(e.get("pieceId")<a.get("pieceId"))return-1*c;if(e.get("pieceId")>a.get("pieceId"))return 1*c}if(Date.parse(e.get("createdAt"))<Date.parse(a.get("createdAt")))return-1*c;if(Date.parse(e.get("createdAt"))>Date.parse(a.get("createdAt")))return 1*
c;if("get"===d.sortPrm[0]){if(e.get("pieceId")<a.get("pieceId"))return-1*c;if(e.get("pieceId")>a.get("pieceId"))return 1*c}return 0};a.storage.userPieceList.sort()},equipInitalize:function(){var b=this.equipInfo;if("formationEquip"==this.mode){this.selectPieceId=this.selectPiece=null;var c=0,d=null;for(this.hideMemoriaList=[];4>c;){var e=b.pieceArr&&b.pieceArr[c]?b.pieceArr[c]:null;c==b.pieceIndex-1&&e?d=e.id:e&&this.hideMemoriaList.push(e);c=c+1|0}this.equipedPiece=d?a.storage.userPieceList.findWhere({id:d}):
null;this.memoriaAbilityEquipNum=b.memoriaAbilityEquipNum;this.memoriaSkillEquipNum=b.memoriaSkillEquipNum;this.equipedPiece&&("ABILITY"==this.equipedPiece.toJSON().piece.pieceType?--this.memoriaAbilityEquipNum:"SKILL"==this.equipedPiece.toJSON().piece.pieceType&&--this.memoriaSkillEquipNum);this.createEquipInfoView();this.trigger("equipAddClass");this.equipMemoriaId&&(this.trigger("equipFirstSet",this.equipMemoriaId),this.equipMemoriaId=null)}},createEquipInfoView:function(){q.prototype.parentView=
this;var b=a.doc.createDocumentFragment(),c=new q({model:new z({})});b.appendChild(c.render().el);a.doc.getElementById("UserMemoriaList").appendChild(b);this.equipInfoView=c},ascStartMemoria:function(b){b.preventDefault();a.isScrolled()||(d.ascSort(b.currentTarget.dataset.ascid),this.orderSet())},orderSet:function(){"asc"===d.getAscId()?(a.addClass(a.doc.getElementById("ascMemoria"),"none"),a.removeClass(a.doc.getElementById("descMemoria"),"none")):(a.addClass(a.doc.getElementById("descMemoria"),
"none"),a.removeClass(a.doc.getElementById("ascMemoria"),"none"))},eventFilterBtn:function(b){b.preventDefault();a.isScrolled()||(b.currentTarget.classList.toggle("on"),d.sortPrm[4]=null!==d.sortPrm[4]?null:"on",a.sfml.UserMemoriaList_card=d.sortPrm,a.sfm(),d.sortPrm[4]?a.addClass(a.doc.getElementById("memoriaWrap"),"onlyEvent"):a.removeClass(a.doc.getElementById("memoriaWrap"),"onlyEvent"),a.scrollRefresh())},sortPopMemoria:function(b){b.preventDefault();a.isScrolled()||d.sortPopupOpen(b)},sortStart:function(b){b.preventDefault();
if(!a.isScrolled()){var c=l.indexOf(d.getSortId());a.removeClass(a.doc.getElementById("memoriaWrapInner"),d.getSortId());c=c+1>=l.length?0:c+1;d.sortPrm[0]=l[c];this.sortBtn=!0;d.multiSort(d.sortPrm);b.currentTarget.innerHTML="\x3cspan class\x3d'b_screen'\x3e\x3c/span\x3e"+t[l[c]];a.addClass(a.doc.getElementById("memoriaWrapInner"),d.getSortId());this.orderSet();"lv"!=d.getSortId()&&"rank"!=d.getSortId()&&"lb"!=d.getSortId()&&this.trigger("dispChange",d.getSortId())}},afterFilterFunc:function(){this.sortBtn?
this.sortBtn=!1:(this.trigger("afterFilter"),d.isFilterOn()?a.doc.getElementById("sortPopupMemoria").className="se_tabs sb_gold_02 TE on":a.doc.getElementById("sortPopupMemoria").className="se_tabs sb_gold_02 TE off",a.scrollRefresh("scrollSet","scrollInner"))},sellReset:function(b){if(b&&(b.preventDefault(),a.isScrolled()))return;a.doc.getElementById("info_sellCount").textContent=0;a.doc.getElementById("info_selectCount").textContent=0;this.trigger("selectReset");this.calcSalePrice();a.addClass(a.doc.getElementById("sellConfirm"),
["noneEvent","off"]);a.scrollRefresh()},calcSalePrice:function(){"MemoriaList"===a.location&&(a.salePriceArr=[],this.trigger("salePrice"),a.doc.getElementById("info_selectCount").textContent=a.salePriceArr.length,a.doc.getElementById("info_sellCount").textContent=function(){return 1>a.salePriceArr.length?0:1===a.salePriceArr.length?a.salePriceArr[0]:a.salePriceArr.reduce(function(a,c,d,e){return a+c|0})}(),1<=a.salePriceArr.length?a.removeClass(a.doc.getElementById("sellConfirm"),"off"):a.addClass(a.doc.getElementById("sellConfirm"),
"off"))},sellConfirm:function(b){b.preventDefault();if(!a.isScrolled()){var c=this;a.selectMemoria=[];this.trigger("selectAddArr");b=a.selectMemoria.length;var d=a.doc.getElementById("info_sellCount").textContent;if(1>b)new a.PopupClass({title:"Sell Memoria",content:"No Memoria are selected to be sold.",closeBtnText:"Cancel",exClass:"memoriaConfirmPop"});else{var e=g.template($("#salePopTemp").text()),h=g.sortBy(this.sellModels,"rank").reverse(),k=!1;if(g.findWhere(h,{rank:"RANK_3"})||g.findWhere(h,
{rank:"RANK_4"})||g.findWhere(h,{rank:"RANK_5"}))k=!0;new a.PopupClass({title:"Sell Memoria",content:e({sellNum:b,sellPrice:d,rarityAlert:k}),decideBtnText:"Sell",closeBtnText:"Cancel",exClass:"memoriaConfirmPop"},null,null,function(){a.removeClass(a.doc.getElementById("memoriaSaleCurtain"),"on");a.removeClass(a.doc.getElementById("memoriaSaleGlowWrap"),"on")});a.removeClass(a.doc.getElementById("popupCurtain"),"show");a.addClass(a.doc.getElementById("memoriaSaleCurtain"),"on");a.addClass(a.doc.getElementById("memoriaSaleGlowWrap"),
"on");a.doc.getElementById("popupArea").getElementsByClassName("decideBtn")[0].addEventListener(a.cgti,function(b){b.preventDefault();a.isScrolled()||c.sellDecide()},!1)}}},sellDecide:function(){if(!k){k=!0;a.androidKeyStop=!0;var b=this,c=[],d;for(d in a.selectMemoria)c.push(a.selectMemoria[d].id);m.ajaxPost(a.linkList.userPieceSell,{saleUserPieceIdList:c},function(c){a.responseSetStorage(c);new a.PopupClass({title:"Sell Memoria",content:"Memoria Sold",closeBtnText:"Close",exClass:"memoriaConfirmPop"},
null,null,function(){k=!1;a.removeClass(a.doc.getElementById("memoriaSaleCurtain"),"on");a.removeClass(a.doc.getElementById("memoriaSaleGlowWrap"),"on")});a.removeClass(a.doc.getElementById("popupCurtain"),"show");b.sellReset();a.doc.getElementById("info_totalGold").textContent=a.storage.gameUser.get("riche");b.trigger("saleUpdate");a.selectMemoria=[];b.sellModels=[];b.calcSalePrice();a.scrollRefresh("scrollSet","scrollInner");a.androidKeyStop=!1})}},selectCommon:function(b){b.preventDefault();a.isScrolled()||
(this.trigger("selectCommons"),this.calcSalePrice())},sizeChange:function(b){b.preventDefault();if(!a.isScrolled()){var c=a.doc.getElementById("memoriaWrap");switch(b.currentTarget.dataset.size){case "smaller":a.addClass(c,"smaller");b.currentTarget.dataset.size="smallest";a.addClass(b.currentTarget,"smaller");b=.8;break;case "smallest":a.removeClass(c,"smaller");a.addClass(c,"smallest");b.currentTarget.dataset.size="normal";a.removeClass(b.currentTarget,"smaller");a.addClass(b.currentTarget,"smallest");
b=.7;break;default:a.removeClass(c,"smallest"),b.currentTarget.dataset.size="smaller",a.removeClass(b.currentTarget,"smallest"),b=1}d.sortPrm[6]=b;d.saveMemory();a.scrollRefresh()}},removeView:function(){this.trigger("removeView");a.doc.getElementById("memoriaSaleCurtain")&&a.doc.getElementById("baseContainer").removeChild(a.doc.getElementById("memoriaSaleCurtain"));a.doc.getElementById("memoriaSaleGlowWrap")&&a.doc.getElementById("baseContainer").removeChild(a.doc.getElementById("memoriaSaleGlowWrap"));
this.off();this.remove()}}),v=h.View.extend({id:"memoriaSaleGlowWrap",initialize:function(){this.listenTo(this.rootView,"removeView",this.removeView);this.template=g.template($("#saleGlow").text());this.createDom()},render:function(){this.$el.html(this.template({gameUser:a.storage.gameUser.toJSON()}));return this},createDom:function(){a.doc.getElementById("baseContainer").appendChild(this.render().el);"sell"===this.rootView.mode&&a.addClass(this.el,"sale")},removeView:function(){this.off();this.remove()}}),
u=h.View.extend({id:"memoriaSaleCurtain",initialize:function(){this.listenTo(this.rootView,"removeView",this.removeView);this.createDom()},render:function(){this.$el.html();return this},createDom:function(){a.doc.getElementById("baseContainer").appendChild(this.render().el)},removeView:function(){this.off();this.remove()}});return A});