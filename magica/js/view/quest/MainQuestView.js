define("underscore backbone backboneCommon ajaxControl command QuestUtil text!template/quest/MainQuest.html js/view/quest/QuestChapterListPartsView text!template/quest/OutlinePopup.html js/view/quest/ClearAnimationsView iscroll_stage".split(" "),function(e,v,a,w,m,h,y,p,z,x){var q=0,r=0,t=0,g,A=v.View.extend({events:function(){var b={};b[a.cgti+" .mapDebugBtn"]=this.debugMapIcon;b[a.cgti+" .modeToggleBtn"]=this.modeToggle;return b},initialize:function(b){this.outline={};this.questMode=a.mainQuestMode||
"NORMAL";this.initFlag=!1;this.listenTo(this,"removeView",this.removeView);this.template=e.template(y);this.createView()},render:function(){this.$el.html(this.template(w.getPageJson()));return this},modeToggle:function(b){b.preventDefault();a.isScrolled()||(this.questMode="HARD"==this.questMode?"NORMAL":"HARD",a.mainQuestMode=this.questMode,this.questListReset(),"HARD"==this.questMode?(a.addClass(a.doc.querySelector("#modeToggleWrap"),"challenge"),a.addClass(a.doc.querySelector("#questList"),"challenge")):
a.removeClass(a.doc.querySelector("#modeToggleWrap"),"challenge"))},questListReset:function(){this.trigger("modeToggle");a.doc.querySelector("#questList").style="";a.removeClass(a.doc.querySelector("#questList"),"allClear");a.removeClass(a.doc.querySelector("#questList"),"challenge");this.createView()},createView:function(){a.content.append(this.render().el);this.initFlag||a.setGlobalView();g=w.getPageJson();t=r=q=0;var b=!1;g.campaignList&&(b=a.campaignParse(g.campaignList));if(b.POINT_UP&&!b.POINT_UP.globalBadge&&
0<b.POINT_UP.pointUpType.length){var n=a.doc.getElementById("questLinkBtnWrap");-1<b.POINT_UP.pointUpType.indexOf("MAIN")&&a.addClass(n.getElementsByClassName("main")[0],"pointUp");if(-1<b.POINT_UP.pointUpType.indexOf("SUB")){var d=a.storage.gameUser.toJSON();d.closeFunctions&&-1===d.closeFunctions.indexOf("ARENA")&&a.addClass(n.getElementsByClassName("side")[0],"pointUp")}(-1<b.POINT_UP.pointUpType.indexOf("CHARA")||-1<b.POINT_UP.pointUpType.indexOf("COSTUME"))&&a.addClass(n.getElementsByClassName("chara")[0],
"pointUp");(-1<b.POINT_UP.pointUpType.indexOf("COMPOSE")||-1<b.POINT_UP.pointUpType.indexOf("MATERIAL"))&&a.addClass(n.getElementsByClassName("event")[0],"pointUp")}var f=[],h=this;e.each(g.userChapterList,function(a){a.halfAp=!1;b&&b.HALF_AP&&e.each(b.HALF_AP.questType,function(c,k){"MAIN"==c&&(0<=b.HALF_AP.chapterIds.indexOf(String(a.chapterId))||0===b.HALF_AP.chapterIds.length)?a.halfAp=!0:"ALL"==c&&(a.halfAp=!0)});a.sectionList=[];e.each(g.userSectionList,function(c,b){if(a.chapterId===c.section.genericId&&
"MAIN"==c.section.questType){if(c.section.questBattleList=[],e.each(g.userQuestBattleList,function(a){if(c.section.sectionId===a.questBattle.sectionId&&(-1!==a.questBattle.missionRewardCode.indexOf("LIVE2D")&&console.log("questBattle:",a.questBattle),h.questMode==a.questBattle.questBattleType)){var b="CLEARED"===a.missionStatus2?"cleared":null,k="CLEARED"===a.missionStatus3?"cleared":null,d=a.cleared?"clear":"new";a.questState="CLEARED"===a.missionStatus1&&b&&k?"comp":d;c.section.questBattleList.push(a)}}),
c.section.questBattleList.length){c.section.questBattleList.sort(function(a,b){return a.questBattle.sectionIndex-b.questBattle.sectionIndex});var k=!1,d=!1;e.each(c.section.questBattleList,function(a,b){"new"==a.questState&&(k=!0);"clear"==a.questState&&(d=!0)});c.sectionState="comp";k?c.sectionState="new":d&&(c.sectionState="clear");"HARD"==h.questMode?c.cleared&&a.sectionList.push(c):(t++,a.sectionList.push(c))}}else"SUB"==c.section.questType?q++:"CHARA"==c.section.questType&&r++});a.sectionList.length&&
(a.sectionList.sort(function(a,b){return a.sectionId>b.sectionId?-1:a.sectionId<b.sectionId?1:0}),f.push(a))});0==t&&"HARD"!==this.questMode&&(a.doc.querySelector("#modeToggleWrap").style.display="none");f.sort(function(a,b){return a.chapter.chapterNo>b.chapter.chapterNo?-1:a.chapter.chapterNo<b.chapter.chapterNo?1:0});p.prototype.template=e.template($("#ChapterParts").text());p.prototype.rootView=this;var l=a.doc.createDocumentFragment();e.each(f,function(b,c){var d=new p({model:b});0===c&&(h.outline=
b,b.cleared||"HARD"===h.questMode||(d.el.className="chapter titleHide open"),c=e.filter(b.sectionList,function(a){return 0==a.cleared}),console.log(c),1==b.sectionList[0].cleared&&"HARD"!==h.questMode&&0===c.length&&a.addClass(a.doc.querySelector("#questList"),"allClear"));if("SINGLERAID"==b.chapter.chapterType||"BRANCH"==b.chapter.chapterType)d.el.className="chapter scrollElm typeSingleRaid se_decide";c="comp";var f=!1,g=!1;e.each(b.sectionList,function(a){"new"==a.sectionState&&(f=!0);"clear"==
a.sectionState&&(g=!0)});c="comp";f?c="new":g&&(c="clear");"new"!==c&&b.chapter.sectionCount>b.sectionList.length&&(c=null);c&&a.addClass(d.el,c);b.halfAp&&a.addClass(d.el,"halfAp");l.appendChild(d.render().el)});a.doc.getElementById("questList").appendChild(l);u.prototype.template=e.template($("#ChapterTitleTemp").text());u.prototype.rootView=this;l=a.doc.createDocumentFragment();this.chapterTitleView=new u({model:{chapterId:f[0].chapterId}});l.appendChild(this.chapterTitleView.render().el);a.doc.getElementById("content").appendChild(l);
this.trigger("appendComp");this.createDom()},createDom:function(){var b="bg_map_"+a.doc.querySelectorAll(".section")[0].querySelector(".param").textContent+".ExportJson";m.changeBg(b);this.scrollListInit();if(this.initFlag)m.getBaseData(a.getNativeObj()),h.canPlayQuestNum(),h.eventTabSwitch(g.eventList);else{this.initFlag=!0;q||(a.removeClass(a.doc.querySelector(".side"),"linkBtn"),a.addClass(a.doc.querySelector(".side"),"off"));r||(a.removeClass(a.doc.querySelector(".chara"),"linkBtn"),a.addClass(a.doc.querySelector(".chara"),
"off"));h.canPlayQuestNum();h.eventTabSwitch(g.eventList);"HARD"==this.questMode?(a.addClass(a.doc.querySelector("#modeToggleWrap"),"challenge"),a.addClass(a.doc.querySelector("#questList"),"challenge")):a.removeClass(a.doc.querySelector("#modeToggleWrap"),"challenge");a.tutorialId&&(a.doc.querySelector("#modeToggleWrap").style.display="none");a.ready.hide();if(a.clearSectionModel){var b=a.clearSectionModel.section,e=h.clearRewardChestColor(b.clearReward);x.section(b.clearRewardCode,b,e,function(){a.clearChapterModel&&
(x.story(a.clearChapterModel.before,a.clearChapterModel.after),a.clearChapterModel=null)});a.clearSectionModel=null}g.sectionOutline&&this.outlinePopup()}},outlinePopup:function(){if(!a.tutorialId&&this.outline){var b=$.extend(!0,{},this.outline.sectionList[0].section);b.title="Story up to Chapter "+this.outline.sectionList[0].chapterNoForView+" Episode "+this.outline.sectionList[0].section.genericIndex;this.outline.sectionList[0].section.outline&&(b.outline=this.outline.sectionList[0].section.outline.replace(/ï¼ /g,
"\x3cbr\x3e"));new a.PopupClass(b,z);m.getBaseData(a.getNativeObj())}},scrollListInit:function(){this.listScroll=new IScroll("#questListWrap",{tap:!0,click:!0,scrollFit:!0,deceleration:.003});this.listScroll.refresh();a.doc.querySelector("#QuestMap");var b=this;this.listScroll.on("setNewPosition",function(e){var d=a.doc.querySelectorAll("#questList .scrollElm")[this.listIndex];if(d){e=b.chapterTitleView.model.chapterId;var f=null;if(d)if(d.classList.contains("chapter")){if(!d.querySelector(".param"))return;
f=Number(d.querySelector(".param").textContent)}else{if(!d.parentNode.parentNode.querySelector(".param"))return;f=Number(d.parentNode.parentNode.querySelector(".param").textContent)}f&&(d="bg_map_"+d.querySelector(".mapPrm").textContent+".ExportJson",m.changeBg(d),f&&e!==f&&(b.chapterTitleView.model.chapterId=f,b.chapterTitleView.render()))}})},removeView:function(){this.off();this.remove()}}),u=v.View.extend({id:"chapterTitleWrap",initialize:function(a){this.listenTo(this.rootView,"removeView",this.removeView);
this.listenTo(this.rootView,"change",this.render)},render:function(){this.$el.html(this.template({model:this.model}));return this},removeView:function(){this.off();this.remove()}});return A});