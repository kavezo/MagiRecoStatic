define("underscore backbone backboneCommon ajaxControl js/card/CardPopup command".split(" "),function(h,k,a,l,n,m){var g=!1;return k.View.extend({className:"shopPopup",events:function(){var b={};b[a.cgti+" #purchaseDecide"]=this.purchaseDecide;b[a.cgti+" #amountPlus"]=this.amountPlus;b[a.cgti+" #amountMinus"]=this.amountMinus;b[a.cgti+" .maxBtn"]=this.amountMax;return b},initialize:function(){this.listenTo(this.rootView,"remove",this.removeView);this.amounts=1;this.tapCount=0},render:function(){var b;
switch(this.parentView.model.needItemId){case "MONEY":b=this.parentView.model.consumeType&&"PURCHASED_MONEY"===this.parentView.model.consumeType?a.getTotalStone().userMoney:a.getTotalStone().totalMoney;break;case "ARENA_COIN":b=(b=a.storage.userItemList.findWhere({itemId:"ARENA_COIN"}))?b.toJSON().quantity:0;break;case "YELL":b=(b=a.storage.userItemList.findWhere({itemId:"YELL"}))?b.toJSON().quantity:0;break;case "PRISM":b=a.storage.userItemList.findWhere({itemId:"PRISM"})?a.storage.userItemList.findWhere({itemId:"PRISM"}).toJSON().quantity:
0;break;case "RICHE":b=a.storage.gameUser.toJSON().riche;break;default:b=a.storage.userItemList.findWhere({itemId:this.parentView.model.needItemId})?a.storage.userItemList.findWhere({itemId:this.parentView.model.needItemId}).toJSON().quantity:0}var e=Math.floor(b/this.parentView.model.needNumber)|0;this.canPurchaseNum=this.parentView.model.limitedNumber?this.parentView.userShopModel?Number(this.parentView.model.limitedNumber)-Number(this.parentView.userShopModel.num)|0:Number(this.parentView.model.limitedNumber):
Infinity;this.maxNumber=this.parentView.model.limitedNumber?Math.min(e,this.canPurchaseNum|0):e;switch(this.parentView.model.needItemId){case "MONEY":e="icon_money_f.png";break;case "RICHE":e="icon_cursechip_f.png";break;default:e=(-1<this.parentView.model.needItemId.indexOf("EVENT_")?"event/":-1<this.parentView.model.needItemId.indexOf("CAMPAIGN_")?"campaign/":"")+"icon_"+this.parentView.model.needItemId.toLowerCase()+"_f.png"}var g=!1;this.parentView.model.consumeType&&"PURCHASED_MONEY"===this.parentView.model.consumeType&&
(g=!0);console.log(g);this.$el.html(this.template({model:this.parentView.model,maxNumber:this.maxNumber,setVal:b,costImage:e,purchasedFlg:g}));return this},purchaseDecide:function(b){b.preventDefault();if(!(a.isScrolled()||g||0<this.tapCount)){this.tapCount++;b=this.parentView.model;a.addClass(a.doc.getElementById("purchaseDecide"),"cantTap");if(b.endAt){var e=Date.parse(b.endAt)/1E3,k=Date.parse(l.getPageJson().currentTime)/1E3+((Date.parse(new Date)/1E3|0)-this.parentView.rootView.shopLimitCounter);
if(e<k){new a.PopupClass({title:"Buy Items",content:"You cannot purchase this Item at this time.",closeBtnText:"OK",exClass:"popupShop"});this.tapCount=0;return}}if(this.canPurchaseNum<this.amounts)new a.PopupClass({title:"Buy Items",content:"Purchase limit reached.",closeBtnText:"OK",exClass:"popupShop"}),this.tapCount=0;else if(1>this.maxNumber)b=this.parentView.model.consumeType&&"PURCHASED_MONEY"===this.parentView.model.consumeType?"Paid Magia Stone":a.storage.itemList.findWhere({itemCode:this.parentView.model.needItemId})?
a.storage.itemList.findWhere({itemCode:this.parentView.model.needItemId}).toJSON().name:"Items needed for purchase.",new a.PopupClass({title:"Buy Items",content:"Insufficient "+b+"(s)",closeBtnText:"OK",exClass:"popupShop"}),this.tapCount=0;else if(1>this.amounts)new a.PopupClass({title:"Buy Items",content:"Select the amount to purchase.",closeBtnText:"OK",exClass:"popupShop"}),this.tapCount=0;else{g=!0;var c=this;b={shopId:b.shopId,shopItemId:b.id,num:this.amounts};1<this.tapCount||l.ajaxPost(a.linkList.shopBuy,
b,function(b){if("error"!==b.resultCode){a.responseSetStorage(b);var f,d=0;switch(c.parentView.model.shopItemType){case "CARD":f=c.parentView.model.card.cardName;c.parentView.model.chara&&c.parentView.model.chara.title&&(f+="("+c.parentView.model.chara.title+")");d="1";break;case "PIECE":case "MAXPIECE":f=c.parentView.model.piece.pieceName;d=a.storage.userPieceList.findWhere({pieceId:Number(c.parentView.model.piece.pieceId)}).length+"";break;case "ITEM":f=c.parentView.model.item.name;d=h.findWhere(b.userItemList,
{itemId:c.parentView.model.genericId});d=d.quantity+d.item.unit;break;case "GIFT":f=c.parentView.model.gift.name;d=h.findWhere(b.userGiftList,{giftId:Number(c.parentView.model.genericId)}).quantity+"";break;case "SET":f=c.parentView.model.name;d=null;break;case "GEM":d=h.findWhere(b.userCharaList,{charaId:Number(c.parentView.model.genericId)});f=c.parentView.model.name;d=d.lbItemNum+"";break;case "FORMATION_SHEET":f=c.parentView.model.formationSheet.name;d="1";break;case "LIVE2D":f=c.parentView.model.name,
d="1"}var e=h.template($("#completePop").text());new a.PopupClass({title:"Purchased",content:e({model:c.parentView.model,itemName:f,hasNum:d}),closeBtnText:"OK",exClass:"completePop"});m.getBaseData(a.getNativeObj());c.tapCount=0;g=!1;c.parentView.amountChange(b.userShopItemList,c.amounts)}});setTimeout(function(){c&&0<c.tapCount&&(g=!1,c.tapCount=0)},1E3)}}},amountPlus:function(b){b.preventDefault();a.isScrolled()||b.currentTarget.classList.contains("off")||(this.amounts++,a.doc.getElementById("amountSelects").innerText=
this.amounts,a.doc.getElementById("totalCost").innerText=this.amounts*(this.parentView.model.needNumber|0),a.removeClass(a.doc.getElementById("amountMinus"),"off"),a.removeClass(a.doc.getElementById("purchaseDecide"),"off"),this.amounts>=this.maxNumber&&a.addClass(b.currentTarget,"off"))},amountMinus:function(b){b.preventDefault();a.isScrolled()||b.currentTarget.classList.contains("off")||(this.amounts--,a.doc.getElementById("amountSelects").innerText=this.amounts,a.doc.getElementById("totalCost").innerText=
this.amounts*(this.parentView.model.needNumber|0),a.removeClass(a.doc.getElementById("amountPlus"),"off"),2>this.amounts&&a.addClass(b.currentTarget,"off"))},amountMax:function(b){b.preventDefault();a.isScrolled()||b.currentTarget.classList.contains("off")||1>this.maxNumber||(this.amounts=this.maxNumber,a.doc.getElementById("amountSelects").innerText=this.amounts,a.doc.getElementById("totalCost").innerText=this.amounts*(this.parentView.model.needNumber|0),a.removeClass(a.doc.getElementById("amountMinus"),
"off"),a.removeClass(a.doc.getElementById("purchaseDecide"),"off"),a.addClass(a.doc.getElementById("amountPlus"),"off"))},removeView:function(){g=!1;this.off();this.remove()}})});