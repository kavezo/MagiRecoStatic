define("underscore backbone backboneCommon ajaxControl command text!template/follow/FollowTop.html js/view/follow/FollowTopListView js/view/follow/FollowSearchResultView js/view/common/PagingView".split(" "),function(D,u,a,r,p,E,l,v,x){var q,g,h,n,w,k,m,F=u.Model.extend(),y=u.Collection.extend({}),f,t=!1;return u.View.extend({events:function(){var b={};b[a.cgti+" #followSearchTab .searchTabBtn"]=this.searchTab;b[a.cgti+" #tabBtn .btn"]=this.tabScreen;b[a.cgti+" #followRefresh"]=this.followSortBtn;
b[a.cgti+" #searchRefresh"]=this.searchRun;b[a.cgti+" input"]=this.inputHandler;return b},initialize:function(a){this.listenTo(this,"beforeSearch",this.beforeSearch);q=r.getPageJson();this.beforePageNum=1;this.template=D.template(E);this.createDom();t=!1},render:function(){this.$el.html(this.template(q));return this},createDom:function(){l.prototype.rootView=this;v.prototype.rootView=this;a.content.append(this.render().el);50<q.followers&&a.addClass(a.doc.getElementById("followerListWrap"),"over50");
this.createView();a.setGlobalView();g="follow";if(a.followSave&&a.followSave.active)switch(g=a.followSave.current?a.followSave.current:"follow",a.followSave.active=!1,g){case "follow":a.doc.getElementById("listTitle").textContent="Follows";a.forceScrollPreset("scrollOuter","followInner",a.followSave.scrollHash,!0);break;case "follower":a.doc.getElementById("listTitle").textContent="Followers";n=!0;this.followerUpdate();a.forceScrollPreset("scrollOuter","followerInner",a.followSave.scrollHash,!0);
break;case "find":a.doc.getElementById("listTitle").textContent="Results";var b=a.followSave.searchRes;h=new v({el:a.doc.getElementById("findListWrap")});h.addResult(b.hits.hits);f=a.followSave.subCurrent;a.removeClass(a.doc.getElementById("followSearchTab").getElementsByClassName("current")[0],"current");a.addClass(a.doc.getElementById("followSearchTab").getElementsByClassName(f)[0],"current");switch(f){case "recommend":a.removeClass(a.doc.getElementById("rankSearchWrap"),"on");a.removeClass(a.doc.getElementById("searchInput"),
"on");break;case "playerName":case "playerId":a.removeClass(a.doc.getElementById("rankSearchWrap"),"on");a.addClass(a.doc.getElementById("searchInput"),"on");a.doc.getElementById("searchInput").value="";b="playerName"===f?"Name":"ID";a.doc.getElementById("searchInput").setAttribute("placeholder","Player"+b);a.doc.getElementById("searchInput").value=a.followSave.searchInput;break;case "playerRank":a.addClass(a.doc.getElementById("rankSearchWrap"),"on"),a.removeClass(a.doc.getElementById("searchInput"),
"on")}a.forceScrollPreset("scrollOuter","searchInner",a.followSave.scrollHash,!0)}else a.followSave={},a.followSave.current="follow",a.doc.getElementById("listTitle").textContent="Follows";a.addClass(a.doc.getElementById("FriendList"),g);a.addClass(a.doc.getElementById("tabBtn").getElementsByClassName(g)[0],"current");p.getBaseData(a.getNativeObj());a.scrollSet("scrollOuter","followInner");a.scrollSet("scrollOuter","followerInner");a.scrollSet("scrollOuter","searchInner");a.ready.hide()},createView:function(){console.log(a.followSave);
a.followSave&&a.followSave.active&&a.followSave.current&&"follower"===a.followSave.current&&(this.beforePageNum=this.pageNum=a.followSave.pagingNum?a.followSave.pagingNum:1);x.parentView=this;var b={count:q.followers,pageLimit:50};1<this.pageNum&&(b.firstPage=this.pageNum);console.log("pagingPrm",b);b=new F(b);this.pagingView=new x({model:b});1<this.pageNum&&this.pagingView.firstMoving();this.maxFollowCnt=0;b=a.storage.userStatusList.findWhere({statusId:"MAX_FOLLOW"});void 0!==b&&(this.maxFollowCnt=
b.toJSON().point);a.doc.getElementById("countFollowWrap").textContent=a.storage.userFollowList.length+"/"+this.maxFollowCnt;if(0!==a.storage.userFollowList.length){this.followSort();var d=a.doc.createDocumentFragment(),c=this;a.storage.userFollowList.each(function(a,b){b=a.toJSON().lastAccessDate?Date.parse(a.toJSON().lastAccessDate)/1E3:null;b=c.calcTimeLag(b);a.set({loginTimeLag:b});b=a.toJSON();if(b.recentUsedAt){var e=r.getPageJson().currentTime.split(" ")[0],z=b.recentUsedAt.split(" ")[0];console.log(e,
z);e===z?(a.set({recentUse:!0}),console.log("this user is recent use.",b.userName)):a.set({recentUse:!1})}else a.set({recentUse:!1});a=(new l({model:a.toJSON()},"follow")).render().el;d.appendChild(a)});a.doc.getElementById("followListWrap").appendChild(d)}else a.doc.getElementById("followListWrap").innerHTML="\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e";window.isBrowser&&a.doc.getElementById("searchInput").removeAttribute("readonly")},inputHandler:function(b){window.isBrowser||(b.preventDefault(),
a.isScrolled()||"searchInput"===b.currentTarget.id&&a.nativeKeyBoard("searchInput",8,null,null,function(){if(0<a.doc.getElementById("searchInput").value.length)a.doc.getElementById("searchInput").setAttribute("placeholder","");else{var b="playerName"===f?"Name":"ID";a.doc.getElementById("searchInput").setAttribute("placeholder","Player"+b)}}))},calcTimeLag:function(a){if(!a)return"day(s) ago";a=(Date.parse(q.currentTime)/1E3-a)/60;16>a?a="15 Min(s) Ago":60>a?a=Math.floor(a)+" Min(s) Ago":60<a&&1440>
a?a=Math.floor(a/60)+" Hour(s) Ago":(a=a/60/24,a=30<a?Math.floor(a/30)+" Month(s) Ago":Math.floor(a)+" Day(s) Ago");return a},allCheckAndChange:function(b,d){switch(d){case "follow":var c=a.storage.userFollowList.findWhere({followUserId:b}).toJSON();d=a.doc.createDocumentFragment();var e=c.lastAccessDate?Date.parse(c.lastAccessDate)/1E3:null,e=this.calcTimeLag(e);c.loginTimeLag=e;c=(new l({model:c},"follow")).render().el;d.appendChild(c);2>a.storage.userFollowList.length&&(a.doc.getElementById("followListWrap").innerHTML=
"");a.doc.getElementById("followListWrap").appendChild(d);p.getBaseData(a.getNativeObj());a.doc.getElementById("countFollowWrap").textContent=a.storage.userFollowList.length+"/"+this.maxFollowCnt;this.trigger("allCheck","follow",b);break;case "unfollow":a.storage.userFollowList.remove(a.storage.userFollowList.findWhere({followUserId:b}));a.doc.getElementById("countFollowWrap").textContent=a.storage.userFollowList.length+"/"+this.maxFollowCnt;this.trigger("allCheck","unfollow",b);1>a.storage.userFollowList.length&&
(a.doc.getElementById("followListWrap").innerHTML="\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e");break;case "block":a.doc.getElementById("countBlockWrap").textContent=(a.doc.getElementById("countBlockWrap").textContent|0)+1;this.trigger("allCheck","block",b);this.blockerUpdate();break;case "unblock":a.doc.getElementById("countBlockWrap").textContent=(a.doc.getElementById("countBlockWrap").textContent|0)-1,this.trigger("allCheck","unblock",b)}a.scrollRefresh()},tabScreen:function(b){b.preventDefault();
if(!a.isScrolled()&&(b.currentTarget.dataset.wrap!==g||"find"===b.currentTarget.dataset.wrap)){var d;switch(b.currentTarget.dataset.wrap){case "follow":d="Follows";break;case "follower":d="Followers";break;case "block":d="Block";break;case "find":f||(f="recommend"),d="Search Results"}a.followSave.current=b.currentTarget.dataset.wrap;"find"!==b.currentTarget.dataset.wrap||h||(this.searchHandler("recommend"),a.followSave.subCurrent="recommend");"follower"===b.currentTarget.dataset.wrap?n||(n=!0,this.followerUpdate()):
"block"!==b.currentTarget.dataset.wrap||w||(w=!0,this.blockerUpdate());a.doc.getElementById("listTitle").textContent=d;a.removeClass(a.doc.getElementById("FriendList"),g);d=a.doc.getElementById("tabBtn").getElementsByClassName("current")[0];a.removeClass(d,"current");a.addClass(a.doc.getElementById("FriendList"),b.currentTarget.dataset.wrap);a.addClass(b.currentTarget,"current");g=b.currentTarget.dataset.wrap;a.scrollRefresh(null,null,!0)}},followSortBtn:function(b){b.preventDefault();if(!a.isScrolled()&&
0!==a.storage.userFollowList.length){this.followSort();var d=a.doc.createDocumentFragment(),c=this;a.storage.userFollowList.each(function(a,b){a.loginTimeLag||(b=a.toJSON().lastAccessDate?Date.parse(a.toJSON().lastAccessDate)/1E3:null,b=c.calcTimeLag(b),a.set({loginTimeLag:b}));a=(new l({model:a.toJSON()},"follow")).render().el;d.appendChild(a)});a.doc.getElementById("followListWrap").appendChild(d);p.getBaseData(a.getNativeObj())}},followSort:function(){var b=a.doc.getElementById("followSort").value.split("-"),
d="asc"===b[1]?1:-1;this.trigger("sortRemove");a.storage.userFollowList.comparator=function(a,e){if("rank"===b[0]){if(e.get("userRank")>a.get("userRank"))return-1*d;if(e.get("userRank")<a.get("userRank"))return 1*d}else if("login"===b[0]){if(e.get("lastAccessDate")<a.get("lastAccessDate"))return-1*d;if(e.get("lastAccessDate")>a.get("lastAccessDate"))return 1*d}else if("followdate"===b[0]){if(e.get("createdAt")<a.get("createdAt"))return-1*d;if(e.get("createdAt")>a.get("createdAt"))return 1*d}};a.storage.userFollowList.sort()},
searchTab:function(b){b.preventDefault();if(!a.isScrolled()&&f!==b.currentTarget.dataset.wrap)switch(a.removeClass(a.doc.getElementById("followSearchTab").getElementsByClassName("current")[0],"current"),a.addClass(b.currentTarget,"current"),f=b.currentTarget.dataset.wrap,a.followSave.subCurrent=f,f){case "recommend":a.removeClass(a.doc.getElementById("rankSearchWrap"),"on");a.removeClass(a.doc.getElementById("searchInput"),"on");this.searchHandler("recommend");break;case "playerName":case "playerId":a.removeClass(a.doc.getElementById("rankSearchWrap"),
"on");a.addClass(a.doc.getElementById("searchInput"),"on");a.doc.getElementById("searchInput").value="";b="playerName"===f?"Name":"ID";a.doc.getElementById("searchInput").setAttribute("placeholder","Player"+b);break;case "playerRank":a.addClass(a.doc.getElementById("rankSearchWrap"),"on"),a.removeClass(a.doc.getElementById("searchInput"),"on")}},searchRun:function(b){b.preventDefault();if(!a.isScrolled()){var d;b=!1;switch(f){case "playerName":case "playerId":(d=a.doc.getElementById("searchInput").value)||
(b=!0);a.followSave.searchInput=d;break;case "playerRank":d=a.doc.getElementById("rankSelect").value}b?new a.PopupClass({title:"Error",content:"No search terms have been entered.",closeBtnText:"Cancel"}):this.searchHandler(f,d)}},searchHandler:function(b,d){h=new v({el:a.doc.getElementById("findListWrap")});var c;switch(b){case "recommend":d=a.storage.gameUser.toJSON();b=1>d.level-5?1:d.level-5;d=d.level+5;var e=Date.parse(q.currentTime)/1E3;c=new Date(1E3*(e-259200));var e=new Date(1E3*(e+600)),
f,g,A,k,l,m,B,C;f=10>c.getMonth()+1?"0"+(c.getMonth()+1):c.getMonth()+1;g=10>c.getDate()?"0"+c.getDate():c.getDate();A=10>c.getHours()?"0"+c.getHours():c.getHours();k=10>c.getMinutes()?"0"+c.getMinutes():c.getMinutes();l=10>e.getMonth()+1?"0"+(e.getMonth()+1):e.getMonth()+1;m=10>e.getDate()?"0"+e.getDate():e.getDate();B=10>e.getHours()?"0"+e.getHours():e.getHours();C=10>e.getMinutes()?"0"+e.getMinutes():e.getMinutes();c=c.getFullYear()+"-"+f+"-"+g+"T"+A+":"+k+":00.000Z";e=e.getFullYear()+"-"+l+"-"+
m+"T"+B+":"+C+":00.000Z";c={size:10,query:{function_score:{query:{bool:{must:[{range:{userRank:{gte:b,lte:d}}},{range:{lastAccessDate:{gte:c,lte:e}}}]}},functions:[{random_score:{}}]}}};break;case "playerName":c={size:10,query:{match_phrase:{userName:d}}};break;case "playerId":c={size:1,query:{term:{inviteCode:{value:d}}}};break;case "playerRank":c={size:10,query:{function_score:{query:{range:{userRank:{gte:Number(d),lte:100}}},functions:[{random_score:{}}]}}}}c.stored_fields="id userName attributeId lastAccessDate inviteCode userRank cardId cardRank displayCardId level revision charaName comment".split(" ");
if(!t){t=!0;var n=this;r.ajaxPost(a.searchLinkList.friend,c,function(b){"error"!==b.resultCode?(n.trigger("beforeSearch"),h.trigger("removeChildView"),a.followSave.searchRes=b,a.doc.getElementById("findListWrap").innerHTML="",0<b.hits.hits.length?h.addResult(b.hits.hits):a.doc.getElementById("findListWrap").innerHTML="\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e"):(n.trigger("beforeSearch"),h.trigger("removeChildView"),a.doc.getElementById("findListWrap").innerHTML="\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e");
t=!1;p.getBaseData(a.getNativeObj());a.scrollRefresh(null,null,!0)})}},followerUpdate:function(){k&&this.trigger("collectRemove","follower");var b=(100*(this.beforePageNum-1)/4|0)/100|0,d=(100*(this.pageNum-1)/4|0)/100|0,c=!0;k?b!=d&&(c=!1):c=!1;this.beforePageNum=this.pageNum;var e=this,f=a.doc.createDocumentFragment(),g=function(b,c){c&&"notApi"===c||(window.isLocal&&(b=JSON.parse(b)),k=new y(b));if(0<k.length){"\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e"===a.doc.getElementById("followerListWrap").innerHTML&&
(a.doc.getElementById("followerListWrap").innerHTML="");var g=50*(e.pageNum-1)-(200*d|0)|0,h=g+49;k.each(function(a,b){g<=b&&b<=h&&(b=a.toJSON().lastAccessDate?Date.parse(a.toJSON().lastAccessDate)/1E3:null,b=e.calcTimeLag(b),a.set({loginTimeLag:b}),a=(new l({model:a.toJSON()},"follower")).render().el,f.appendChild(a))});a.doc.getElementById("followerListWrap").appendChild(f);p.getBaseData(a.getNativeObj())}else a.doc.getElementById("followerListWrap").innerHTML="\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e";
setTimeout(function(){f=null;a.scrollRefresh()},100)};c?g(k,"notApi"):window.isLocal?(b=6E4*((new Date).getTime()/6E4|0),require(["text!/magica/json//friend/follower/list.json?bust\x3d"+b],function(a){g(a)}),console.log("apiPage",d+1|0)):r.ajaxSimpleGet(a.linkList.followerList,d+1|0,g)},blockerUpdate:function(){m&&(m=null,this.trigger("collectRemove","block"));var b=this,d=a.doc.createDocumentFragment();r.ajaxSimpleGet(a.linkList.blockList,"",function(c){window.isLocal&&(c=JSON.parse(c));m=new y(c);
0<m.length?("\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e"===a.doc.getElementById("blockListWrap").innerHTML&&(a.doc.getElementById("blockListWrap").innerHTML=""),m.each(function(a,c){c=a.toJSON().lastAccessDate?Date.parse(a.toJSON().lastAccessDate)/1E3:null;c=b.calcTimeLag(c);a.set({loginTimeLag:c});a=(new l({model:a.toJSON()},"block")).render().el;d.appendChild(a)}),a.doc.getElementById("blockListWrap").appendChild(d),p.getBaseData(a.getNativeObj())):a.doc.getElementById("blockListWrap").innerHTML=
"\x3cdiv class\x3d'noUser'\x3eNo Matching Player\x3c/div\x3e";a.scrollRefresh(null,null,!0)})},beforeSearch:function(){this.trigger("collectRemove","search")},removeHandler:function(){h&&h.trigger("removeChildView");k=f=w=n=h=null;this.pagingView.removeView();this.trigger("collectRemove","search");this.trigger("removeView");a.followSave&&!a.followSave.active&&(a.followSave=null);this.off();this.remove()}})});