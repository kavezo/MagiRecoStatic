define("underscore backbone backboneCommon ajaxControl command text!template/arena/ArenaTop.html js/view/arena/ArenaInfoPartsView dateUtil".split(" "),function(h,r,a,p,t,u,q,f){var g;return r.View.extend({events:function(){var b={};b[a.cgti+" .limitedBtn"]=this.conditionPopup;b[a.cgti+" .mirrorsEnter"]=this.infinitEnter;b[a.cgti+" .rankingEnter"]=this.rankingEnter;return b},initialize:function(b){this.template=h.template(u);this.model=p.getPageJson();this.arenaJson=a.storage.userArenaBattle.toJSON();
b=this.nowRankStoryCheck();this.canPlay=this.conditionCheck(b);this.rankingInitialize();this.nextCondition=this.canPlay?this.checkNextRankCondition():!1;this.createDom()},rankingInitialize:function(){this.ranking={};this.ranking.rankingClose=this.model.rankingClosing;this.ranking.rankingEventStatus=!1;this.ranking.canEnter=!1;if(this.model.eventArenaRanking){a.eventArenaRanking=this.model.eventArenaRanking;var b=h.findWhere(this.model.eventList,{eventId:this.model.eventArenaRanking.eventId});a.storage.userArenaBattle.toJSON();
if(!this.rankingClose&&b&&this.model.eventArenaRanking){this.ranking.shopId=b.shopId;this.ranking.itemId=this.model.eventArenaRanking.rewardItemId.toLowerCase();var c=a.storage.userItemList.findWhere({itemId:this.model.eventArenaRanking.rewardItemId})?a.storage.userItemList.findWhere({itemId:this.model.eventArenaRanking.rewardItemId}).get("quantity"):0;this.ranking.itemHasNum=c;var c=Date.parse(this.model.currentTime),e=this.model.eventArenaRanking,d=a.storage.gameUser.toJSON(),g=Date.parse(e.preliminaryRoundStartAt),
k=Date.parse(e.preliminaryRoundEndAt),m=Date.parse(e.finalRoundStartAt),l=Date.parse(e.finalRoundEndAt),n;c>=g&&c<k?(this.ranking.rankingEventStatus="prelim",this.ranking.rankingBattleMaxCount=e.preliminaryRoundBattleCount,this.ranking.rankingBattleLeftCount=d.remainBattleCountOfRanking?d.remainBattleCountOfRanking:0,this.ranking.canEnter=0<this.ranking.rankingBattleLeftCount?!0:!1,this.ranking.battleLimit=f.dateTimeDisplay(new Date(new Date(k))),n=k):c>=k&&c<m?(this.ranking.rankingEventStatus="counting",
this.ranking.battleLimit=f.dateTimeDisplay(new Date(new Date(m)))):c>=m&&c<l?(this.ranking.rankingEventStatus="final",this.ranking.rankingBattleMaxCount=e.finalRoundBattleCount,this.ranking.rankingBattleLeftCount=d.remainBattleCountOfRanking?d.remainBattleCountOfRanking:0,this.ranking.canEnter=0<this.ranking.rankingBattleLeftCount?!0:!1,this.ranking.battleLimit=f.dateTimeDisplay(new Date(new Date(l))),n=l):c>=l&&(this.ranking.rankingEventStatus="isOver",this.ranking.battleLimit=f.dateTimeDisplay(new Date(new Date(b.endAt))));
a.eventArenaRanking.tarm=this.ranking.rankingEventStatus;a.eventArenaRanking.tarmEnd=n}}else a.eventArenaRanking=null},render:function(b){this.rankingOpenStatus();b=a.storage.userCardList.findWhere({id:a.storage.gameUser.get("leaderId")}).toJSON().displayCardId;var c=a.storage.userItemList.findWhere({itemId:"ARENA_COIN"})?a.storage.userItemList.findWhere({itemId:"ARENA_COIN"}).toJSON().quantity:0,e=!1,d=a.campaignParse(this.model.campaignList);d.ARENA_REWARD_UP&&(e=d.ARENA_REWARD_UP.magnification);
this.$el.html(this.template({model:this.arenaJson,dontReach:!1,chips:c,gameUser:a.storage.gameUser.toJSON(),leader:b,canPlay:this.canPlay,nextCondition:this.nextCondition,ranking:this.ranking,campaign:e}));return this},createDom:function(){a.content.append(this.render().el);q.prototype.rootView=this;this.infoView=new q;a.doc.getElementById("bpGuageTop").appendChild(this.infoView.render().el);a.setGlobalView();g=this;t.getBaseData(a.getNativeObj());this.diffencivePopup();a.firstNaviCheck(p.getPageJson());
a.ready.hide()},infinitEnter:function(b){b.preventDefault();a.isScrolled()||(this.ranking.rankingEventStatus?"counting"===this.ranking.rankingEventStatus||"isOver"===this.ranking.rankingEventStatus?new a.PopupClass({title:"Calculating Mirrors Ranking Results",content:"Results from the Mirrors Ranking are being calculated. Mirrors Battles are not available at this time.",closeBtnText:"OK",popupType:"typeC"}):this.canPlay?location.href="#/ArenaFreeRank":this.conditionPopup(b):this.canPlay?location.href=
"#/ArenaFreeRank":this.conditionPopup(b))},rankingEnter:function(b){b.preventDefault();if(!a.isScrolled())if(this.ranking.canEnter)location.href="#/EventArenaRankingTop";else if(this.ranking.rankingEventStatus&&!this.ranking.rankingClose){b=Date.parse(this.model.currentTime);var c=this.model.eventArenaRanking,e=Date.parse(c.preliminaryRoundEndAt),c=Date.parse(c.finalRoundStartAt),c=f.dateTimeDisplay(new Date(c)),d=new Date;d.setHours(2);d.setMinutes(0);d.setSeconds(0);d=f.dst(d)?"PDT":"PST";"prelim"===
this.ranking.rankingEventStatus?b<e-864E5?new a.PopupClass({title:"Mirrors Ranking",content:"You have reached today's battle limit. The counter will be reset at 2:00 AM "+d+".",closeBtnText:"OK",popupType:"typeC"}):new a.PopupClass({title:"Mirrors Ranking",content:"You have reached today's battle limit. \x3cbr\x3eFinals will start at "+c+".",closeBtnText:"OK",popupType:"typeC"}):"final"===this.ranking.rankingEventStatus&&new a.PopupClass({title:"Mirrors Ranking",content:"Your battle limit has been reached.\x3cbr\x3eResults coming soon!",
closeBtnText:"OK",popupType:"typeC"})}else this.ranking.rankingEventStatus&&this.ranking.rankingClose?"counting"===this.ranking.rankingEventStatus?(b=Date.parse(this.model.eventArenaRanking.finalRoundStartAt),b=f.dateTimeDisplay(new Date(new Date(b))),new a.PopupClass({title:"Calculating Mirrors Ranking Results",content:"Results from the Mirrors Ranking are being calculated. \x3cbr\x3eYou cannot play Mirrors Battles at the moment.\x3cbr\x3eThe Battles are scheduled to be resumed at "+b+".",closeBtnText:"OK",
popupType:"typeC"})):"isOver"===this.ranking.rankingEventStatus&&new a.PopupClass({title:"Calculating Mirrors Ranking Results",content:"Results from the Mirrors Ranking are being calculated. Mirrors Battles are not available at this time.",closeBtnText:"OK",popupType:"typeC"}):new a.PopupClass({title:"Mirrors Ranking",content:"There is no Mirrors Ranking in session.\x3cbr\x3ePlease wait for the next one.",closeBtnText:"OK",popupType:"typeC"})},nowRankStoryCheck:function(){var b;if(a.arenaStoryPlay)b=
!0;else if(b=a.storage.userQuestAdventureList.findWhere({adventureId:this.arenaJson.currentFreeRankClass.storyId}),!b)if(this.arenaJson.currentFreeRankClass.openConditionSectionId){var c=a.storage.userSectionList.findWhere({sectionId:Number(this.arenaJson.currentFreeRankClass.openConditionSectionId)});if(this.sectionCheck=c&&c.toJSON().cleared?!0:!1)a.arenaStoryPlay=!0}else b=!0,a.arenaStoryPlay=!0;return b},diffencivePopup:function(){if(this.model.arenaBonusResult&&0<this.model.arenaBonusResult.total){var b=
this.model.arenaBonusResult,c=h.template($("#yestadayBonus").text());new a.PopupClass({title:"Yesterday's Defense Bonus",content:c({model:b}),exClass:"yestadayBonus",popupType:"typeC"})}},rankingOpenStatus:function(){var b=!0,a=this.arenaJson.currentFreeRankClassType.split("_");4<(a[a.length-1]|0)&&(b=!1);return b},conditionCheck:function(b){"FREE_RANK_1"===this.arenaJson.currentFreeRankClassType?(b=!0,a.storage.userQuestAdventureList.findWhere({adventureId:this.arenaJson.currentFreeRankClass.storyId})||
(a.arenaStoryPlay=!0)):b=b?!0:this.sectionCheck?!0:!1;return b},checkNextRankCondition:function(){return this.arenaJson.nextFreeRankClass?this.arenaJson.nextFreeRankClass.openConditionSection?!0:!1:!1},conditionPopup:function(b){b.preventDefault();if(!a.isScrolled()){b=this.nextCondition?g.arenaJson.nextFreeRankClass:g.arenaJson.currentFreeRankClass;var c=b.openConditionChapter,e=h.template($("#limitedPopup").text());new a.PopupClass({title:b.className+"ãƒ»Requirements to Unlock Story",content:e({conditionText:"Complete Chapter\x26nbsp;"+
c.chapterNoForView+" Episode\x26nbsp;"+b.openConditionSection.genericIndex+" of the Main Story"}),closeBtnText:"Cancel",exClass:"conditionPopup",popupType:"typeC"})}},removeHandler:function(){a.arenaClearFlag&&(a.arenaClearFlag=!1);g=null;this.trigger("removeView");this.off();this.remove()}})});