define("underscore backbone backboneCommon ajaxControl command text!template/mission/MissionTop.html js/view/mission/MissionTopListView".split(" "),function(g,u,a,p,v,w,q){var m,k,r={};return u.View.extend({events:function(){var b={};b[a.cgti+" #tabBtn .btn"]=this.tabScreen;b[a.cgti+" #allReserve"]=this.allReserve;return b},initialize:function(a){m=p.getPageJson();this.firstViewId=a.dispId;this.template=g.template(w);this.createDom()},render:function(){this.$el.html(this.template(m));return this},
createDom:function(){a.content.append(this.render().el);this.eventMission=this.makeEventMissionList();this.eventMissionClassList=[];r={};m.userDoppelChallengeList&&g.each(m.userDoppelChallengeList,function(a,b){b=a.challenge.charaNo;r[b]||(r[b]=[]);r[b].push(a)});this.createView();this.clearMissionCount("firstTime");this.dailyCalcLeftTime();a.setGlobalView();k="mission1";this.allReservCheck();a.scrollSet("missionScrollWrap","dailyList");a.scrollSet("missionScrollWrap","totalList");m.userDoppelChallengeList&&
a.scrollSet("missionScrollWrap","doppelList");a.scrollSet("tabScroll","common_tab");if(0<this.eventMissionClassList.length)for(var b=this.eventMissionClassList.length;0<b;)b=b-1|0,a.scrollSet("missionScrollWrap",this.eventMissionClassList[b]);null!==this.firstViewId&&"DAILY"!==this.firstViewId&&this.checkFirstView();v.getBaseData(a.getNativeObj());a.ready.hide()},createView:function(){q.prototype.rootView=this;q.prototype.template=g.template(a.doc.getElementById("missionParts").textContent);this.createDailyMissionList();
this.createTotalMissionList();this.eventMission&&this.createEventMissionList();m.userDoppelChallengeList&&this.createDoppelMissionList()},createDailyMissionList:function(){var b=a.doc.createDocumentFragment(),c=m.currentTime.substr(0,10),f=a.storage.gameUser.toJSON(),d=0,h=a.storage.userDailyChallengeList.toJSON(),h=g.sortBy(h,function(a){return a.clearedCount>=a.challenge.count?-999+a.challenge.sortKey:a.challenge.sortKey});g.each(h,function(a,h){if(!a.receivedAt||a.receivedAt.substr(0,10)!==c){var l;
switch(a.challenge.bean){case "CLEAR_SUB_QUEST_TODAY":case "ARENA_BATTLE_TODAY":l="ARENA";h=!0;break;default:h=!1}h&&f.closeFunctions&&-1<f.closeFunctions.indexOf(l)||(a=new q(a,"daily"),b.appendChild(a.render().el),d++)}});1>d?a.doc.getElementById("mission1").innerHTML='\x3cp class\x3d"noMission ts_white"\x3eThere are no available Missions\x3c/p\x3e':a.doc.getElementById("mission1").appendChild(b);b=null},createTotalMissionList:function(){var b=a.doc.createDocumentFragment(),c=a.storage.gameUser.toJSON(),
f=0,d=a.storage.userTotalChallengeList.toJSON(),d=g.sortBy(d,function(a){return a.clearedCount>=a.challenge.count?-999+a.challenge.sortKey:a.challenge.sortKey});g.each(d,function(a,d){if(!a.receivedAt){var h;switch(a.challenge.bean){case "CLEAR_SUB_CHAPTER":case "ARENA_BATTLE":case "ARENA_WIN":h="ARENA";d=!0;break;case "USER_FOLLOW":h="FRIEND";d=!0;break;default:d=!1}d&&c.closeFunctions&&-1<c.closeFunctions.indexOf(h)||(a=new q(a,"total"),b.appendChild(a.render().el),f++)}});1>f?a.doc.getElementById("mission2").innerHTML=
'\x3cp class\x3d"noMission ts_white"\x3eThere are no available Missions\x3c/p\x3e':a.doc.getElementById("mission2").appendChild(b);b=null},makeEventMissionList:function(){if(a.storage.userLimitedChallengeList.toJSON()){var b=[],c=Date.parse(m.currentTime),f=g.sortBy(m.limitedChallengeGroupList,function(a){return a.sortKey}),d=a.storage.userLimitedChallengeList.toJSON(),d=g.sortBy(d,function(a){return a.challenge.sortKey}),h=g.groupBy(d,function(a){return a.challenge.groupId});g.each(f,function(a,
d){d=Date.parse(a.startAt);var l=a.closeAt?Date.parse(a.closeAt):Date.parse(a.endAt);a.openFlag=d<=c&&l>=c?!0:!1;a.checkId="e_"+a.id;a.missionList=h[a.id]?h[a.id]:[];b.push(a)});return b}},createEventMissionList:function(){var b=Date.parse(p.getPageJson().currentTime),c=[],f=this;g.each(this.eventMission,function(d,h){c[h]=0;if(d.openFlag){var t=a.doc.createDocumentFragment(),e=d.checkId,l=g.sortBy(d.missionList,function(a){return a.clearedCount>=a.challenge.count?-999+a.challenge.sortKey:a.challenge.sortKey}),
n=Date.parse(d.endAt),k=d.closeAt?Date.parse(d.closeAt):n,m=b>n&&b<k?!0:!1;g.each(l,function(a,b){a.receivedAt||m&&a.clearedCount<a.challenge.count||(a=new q(a,e),t.appendChild(a.render().el),c[h]++)});0<c[h]?(l=a.doc.createElement("div"),l.id=e,l.className="limitedWrap "+e,l.appendChild(t),n=a.doc.createElement("li"),n.className="btn TE se_tabs "+e,n.dataset.wrap=e,d=d.shortName?d.shortName.replace(/＠/g,"\x3cbr\x3e"):d.shortTitle.replace(/＠/g,"\x3cbr\x3e"),n.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e\x3cdiv class\x3d'batch "+
e+"_batch'\x3e\x3c/div\x3e",n.innerHTML=55<d.length?"\x3cspan style\x3d'font-size:15px; line-height:15px'\x3e"+d+"\x3c/span\x3e\x3cdiv class\x3d'batch "+e+"_batch'\x3e\x3c/div\x3e":36<d.length?"\x3cspan style\x3d'font-size:16px; line-height:16px'\x3e"+d+"\x3c/span\x3e\x3cdiv class\x3d'batch "+e+"_batch'\x3e\x3c/div\x3e":"\x3cspan\x3e"+d+"\x3c/span\x3e\x3cdiv class\x3d'batch "+e+"_batch'\x3e\x3c/div\x3e",f.eventMissionClassList.push(e),a.doc.getElementById("tabBtn").getElementsByClassName("common_tab")[0].appendChild(n),
a.doc.getElementById("missionScrollWrap").appendChild(l),l=n=null):m||(l=a.doc.createElement("div"),l.id=e,l.className="limitedWrap "+e,l.innerHTML='\x3cp class\x3d"noMission ts_white"\x3eThere are no available Missions\x3c/p\x3e',n=a.doc.createElement("li"),n.className="btn TE se_tabs "+e,n.dataset.wrap=e,d=d.shortName?d.shortName.replace(/＠/g,"\x3cbr\x3e"):d.shortTitle.replace(/＠/g,"\x3cbr\x3e"),n.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e\x3cdiv class\x3d'batch "+e+"_batch'\x3e\x3c/div\x3e",f.eventMissionClassList.push(e),
a.doc.getElementById("tabBtn").getElementsByClassName("common_tab")[0].appendChild(n),a.doc.getElementById("missionScrollWrap").appendChild(l),l=n=null)}})},createDoppelMissionList:function(){a.doppelMissionList=null;var b=a.doc.createElement("li");b.className="btn TE se_tabs doppelMissionTab";b.innerHTML="\x3cspan\x3eUnleash\x3cbr\x3eDoppel Stage\x3c/span\x3e";b.dataset.wrap="doppelMission";b.dataset.missionName="Doppel Unleashing Challenge";a.doc.getElementById("tabBtn").getElementsByClassName("common_tab")[0].appendChild(b);
g.each(r,function(b,f,d){g.sortBy(b,function(a){return a.clearedCount>=a.challenge.count?-999+a.challenge.sortKey:a.challenge.sortKey});var c=0,t=0;g.each(b,function(a,b){a.receivedAt?t++:a.clearedCount>=a.challenge.count&&c++});d="/magica/resource/image_web/page/mission/doppelMission/"+f+"01/banner.png";var e=a.doc.createElement("div");e.className="banner TE se_decide linkBtn";e.innerHTML="\x3cdiv class\x3d'img'\x3e\x3c/div\x3e\x3cspan class\x3d'badge'\x3e"+c+"\x3c/span\x3e";e.dataset.href="#/DoppelMissionTop/"+
f;e.querySelector(".img").style.backgroundImage="url('"+d+"')";e.querySelector(".img").style.backgroundSize="100% 100%";e.missionList=b;0<c&&(a.addClass(e,"badge"),a.addClass(a.doc.querySelector(".doppelMissionTab"),"badge"));t==b.length&&a.addClass(e,"comp");a.doc.querySelector("#doppelMission").appendChild(e)});$("#doppelMission .banner").bind(a.cgti,function(b){a.doppelMissionList=b.currentTarget.missionList})},checkFirstView:function(){var b=this,c=!1;"TOTAL"===this.firstViewId?c="mission2":"DOPPELMISSION"===
this.firstViewId?c="doppelMissionTab":g.each(this.eventMission,function(a,d){a.eventId&&a.eventId===Number(b.firstViewId)?a.openFlag&&(c=a.checkId):a.campaignId&&a.campaignId===Number(b.firstViewId)&&a.openFlag&&(c=a.checkId)});c?this.tabScreen(null,c):new a.PopupClass({title:"Not in Session",content:"This Mission is not available",closeBtnText:"OK",popupType:"typeC"});this.firstViewId=null},dailyCalcLeftTime:function(){var b;b=Date.parse(m.currentTime)/1E3;var c=new Date(1E3*(b+86400));b=(Date.parse(c.getMonth()+
1+"/"+c.getDate()+"/"+c.getFullYear()+" 0:00:00")/1E3-b)/60;60>b?b=Math.floor(b)+" Minute(s)":60<b&&1440>b?b=Math.floor(b/60)+" Hours":(b=b/60/24,b=30<b?Math.floor(b/30)+" Month(s)":Math.floor(b)+"day(s)");a.doc.getElementById("dailyTimeNum").innerText=b},eventCalcLeftTime:function(b){b=b.closeAt?new Date(b.closeAt):new Date(b.endAt);b=b.getMonth()+1+"/"+b.getDate()+" "+b.getHours()+":"+b.getMinutes();a.doc.getElementById("eventTimeNum").textContent=b},tabScreen:function(b,c){if(b){b.preventDefault();
if(a.isScrolled()||b.currentTarget.dataset.wrap===k)return;b=b.currentTarget}else b=a.doc.getElementById("tabBtn").getElementsByClassName(c)[0];c=a.doc.getElementById("tabBtn").getElementsByClassName("current")[0];a.removeClass(c,"current");"mission1"!==k&&"mission2"!==k&&"doppelMission"!==k?a.removeClass(a.doc.getElementById(k),"on"):a.removeClass(a.doc.getElementById("MissionList"),k);if("mission1"!==b.dataset.wrap&&"mission2"!==b.dataset.wrap&&"doppelMission"!==b.dataset.wrap){if(a.addClass(a.doc.getElementById(b.dataset.wrap),
"on"),c=g.findWhere(this.eventMission,{checkId:b.dataset.wrap}))this.eventCalcLeftTime(c),a.addClass(a.doc.getElementById("eventTime"),"on"),a.doc.getElementById("listTitle").textContent=c.name?c.name.replace(/＠/g,""):c.title.replace(/＠/g,"")}else a.removeClass(a.doc.getElementById("eventTime"),"on"),a.addClass(a.doc.getElementById("MissionList"),b.dataset.wrap),c=b.dataset.missionName.replace(/＠/g,"\x3cbr\x3e"),a.doc.getElementById("listTitle").textContent=c;a.addClass(b,"current");k=b.dataset.wrap;
this.allReservCheck();switch(k){case "mission1":a.scrollRefresh("missionScrollWrap","dailyList",!0);break;case "mission2":a.scrollRefresh("missionScrollWrap","totalList",!0);break;case "doppelMission":a.scrollRefresh("missionScrollWrap","doppelList",!0);break;default:a.scrollRefresh("missionScrollWrap",k,!0)}},clearMissionCount:function(b){var c=0,f=0,d=m.currentTime.substr(0,10);a.storage.userDailyChallengeList.each(function(a,b){a=a.toJSON();a.receivedAt&&a.receivedAt.substr(0,10)===d||a.clearedCount>=
a.challenge.count&&c++});a.storage.userTotalChallengeList.each(function(a,b){a=a.toJSON();a.receivedAt||a.clearedCount>=a.challenge.count&&f++});0<c?(a.doc.getElementById("dailyBatch").textContent=c,a.addClass(a.doc.getElementById("dailyBatch"),"on")):a.removeClass(a.doc.getElementById("dailyBatch"),"on");0<f?(a.doc.getElementById("totalBatch").textContent=f,a.addClass(a.doc.getElementById("totalBatch"),"on")):a.removeClass(a.doc.getElementById("totalBatch"),"on");this.eventMission&&(b||(this.eventMission=
this.makeEventMissionList()),g.each(this.eventMission,function(b,d){if(b.openFlag){d=a.doc.getElementById("tabBtn").getElementsByClassName(b.checkId+"_batch")[0];var c=0;g.each(b.missionList,function(a,b){a.receivedAt||a.clearedCount>=a.challenge.count&&c++});0<c?(d.textContent=c,a.addClass(d,"on")):a.removeClass(d,"on")}}))},allReserve:function(b){b.preventDefault();if(!(a.isScrolled()||b.currentTarget.classList.contains("off")||0<this.tapCount)){this.tapCount++;a.addClass(a.doc.getElementById("allReserve"),
"off");var c=this,f=[];switch(k){case "mission1":var d=m.currentTime.substr(0,10);p.ajaxPost(a.linkList.userDailyAllReceive,{},function(b){if("error"!==b.resultCode){var h=0;a.storage.userDailyChallengeList.each(function(a,b){a&&(a=a.toJSON(),(!a.receivedAt||a.receivedAt.substr(0,10)!==d)&&a.clearedCount>=a.challenge.count&&(f.push(a.challengeId),h++))});var e=function(){c.trigger("afterAllRecieve","daily",f);c.allReservCheck();c.clearMissionCount();c.tapCount=0;a.addClass(a.doc.getElementById("allReserve"),
"off");a.scrollRefresh(null,null,!0)};1>Object.keys(b).length||window.isLocal&&window.isBrowser&&2>Object.keys(b).length?new a.PopupClass({content:"This Mission Reward has expired.\x3cbr\x3eYou cannot receive expired Rewards.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,e):(new a.PopupClass({content:h+" Mission Reward(s) Received\x3cbr\x3e\x3cbr\x3e※Item(s) can be found in your Inventory.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,e),a.responseSetStorage(b))}});
break;case "mission2":p.ajaxPost(a.linkList.userTotalAllReceive,{},function(b){if("error"!==b.resultCode){var d=0;a.storage.userTotalChallengeList.each(function(a,b){a&&(a=a.toJSON(),!a.receivedAt&&a.clearedCount>=a.challenge.count&&(f.push(a.challengeId),d++))});var e=function(){c.trigger("afterAllRecieve","total",f);c.allReservCheck();c.clearMissionCount();c.tapCount=0;a.addClass(a.doc.getElementById("allReserve"),"off");a.scrollRefresh(null,null,!0)};1>Object.keys(b).length||window.isLocal&&window.isBrowser&&
2>Object.keys(b).length?new a.PopupClass({content:"This Mission Reward has expired.\x3cbr\x3eYou cannot receive expired Rewards.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,e):(new a.PopupClass({content:d+" Mission Reward(s) Received\x3cbr\x3e\x3cbr\x3e※Item(s) can be found in your Inventory.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,e),a.responseSetStorage(b))}});break;default:this.allReserveAdvance()}}},allReserveAdvance:function(){var b=this,
c=k.split("_"),f={};"e"===c[0]&&(f.groupId=Number(c[1]),p.ajaxPost(a.linkList.userLimitedChallengeAllReceieve,f,function(d){if("error"!==d.resultCode){var c=g.findWhere(b.eventMission,{checkId:k}),f=0,e=[];g.each(c.missionList,function(a,b){a&&!a.receivedAt&&a.clearedCount>=a.challenge.count&&(e.push(a.challengeId),f++)});c=function(){b.trigger("afterAllRecieve",k,e);b.allReservCheck();b.clearMissionCount();b.tapCount=0;a.addClass(a.doc.getElementById("allReserve"),"off");a.scrollRefresh(null,null,
!0)};1>Object.keys(d).length||window.isLocal&&window.isBrowser&&2>Object.keys(d).length?new a.PopupClass({content:"This Mission Reward has expired.\x3cbr\x3eYou cannot receive expired Rewards.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,c):new a.PopupClass({content:f+" Mission Reward(s) Received\x3cbr\x3e\x3cbr\x3e※Item(s) can be found in your Inventory.",closeBtnText:"OK",popupType:"typeC",exClass:"missionPop"},null,null,c);a.responseSetStorage(d);b.eventMission=b.makeEventMissionList()}}))},
allReservCheck:function(){a.removeClass(a.doc.getElementById("allReserve"),"hide");switch(k){case "mission1":var b=0,c=m.currentTime.substr(0,10);a.storage.userDailyChallengeList.each(function(a,f){a=a.toJSON();a.receivedAt&&a.receivedAt.substr(0,10)===c||a.clearedCount>=a.challenge.count&&b++});0<b?a.removeClass(a.doc.getElementById("allReserve"),"off"):a.addClass(a.doc.getElementById("allReserve"),"off");break;case "mission2":var f=0;a.storage.userTotalChallengeList.each(function(a,b){a=a.toJSON();
a.receivedAt||a.clearedCount>=a.challenge.count&&f++});0<f?a.removeClass(a.doc.getElementById("allReserve"),"off"):a.addClass(a.doc.getElementById("allReserve"),"off");break;case "doppelMission":a.addClass(a.doc.getElementById("allReserve"),"hide");break;default:a.addClass(a.doc.getElementById("allReserve"),"off"),this.allReserveCheckAdvance()}},allReserveCheckAdvance:function(){var b=g.findWhere(this.eventMission,{checkId:k}),c=0;g.each(b.missionList,function(a,b){a.receivedAt||a.clearedCount>=a.challenge.count&&
c++});0<c?a.removeClass(a.doc.getElementById("allReserve"),"off"):a.addClass(a.doc.getElementById("allReserve"),"off")},removeView:function(){this.trigger("removeChildView");this.off();this.remove()}})});