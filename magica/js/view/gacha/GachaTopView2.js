define("underscore backbone backboneCommon ajaxControl command text!template/gacha/GachaTop.html js/gacha/GachaProbability js/view/gacha/GachaBtnView dateUtil".split(" "),function(c,n,b,v,g,w,x,p,q){var u=n.Model.extend({}),k,h,m,y=n.View.extend({events:function(){var a={};a[b.cgti+" #leftArrow"]=this.gachaChange;a[b.cgti+" #rightArrow"]=this.gachaChange;a["webkitTransitionEnd #gachaWrap .onDisp"]=this.charaImageAnimationEnd;a["webkitanimationend #gachaWrap .onDisp"]=this.charaImageAnimationEnd;a["webkitAnimationEnd #gachaWrap .onDisp"]=
this.charaImageAnimationEnd;a["animationend #gachaWrap .onDisp"]=this.charaImageAnimationEnd;a["touchstart #gachaWrap"]=this.swipeStart;a["touchmove #gachaWrap"]=this.swipeing;a["touchend #gachaWrap"]=this.swipeEnd;return a},swipeStart:function(a){2>this.gachaScheduleList.length||(this.touching=!0,this.touchPoint=a.originalEvent.changedTouches[0].clientX)},swipeing:function(a){if(!(!this.touching||2>this.gachaScheduleList.length||(a=a.originalEvent.changedTouches[0].clientX-this.touchPoint,250>a&&
-250<a))){this.touching=!1;g.startSe(1002);var b=0;-250>a?b=1:250<a&&(b=-1);this.gachaChange(null,b)}},swipeEnd:function(a){!this.touching||2>this.gachaScheduleList.length||(this.touching=!1)},initialize:function(a){m=v.getPageJson();var e=[];c.each(m.gachaScheduleList,function(a,b){a=c.clone(a);a.gachaGroupId&&(b=c.findWhere(m.userGachaGroupList,{gachaGroupId:a.gachaGroupId})||null,console.log("gachaGroup",b),b&&(a.gachaGroup=b));e.push(a)});this.gachaIndex=0;this.gachaScheduleList=e;if(b.gachaDisp){var f=
{};isFinite(b.gachaDisp)?f.id=Number(b.gachaDisp):f.gachaType=b.gachaDisp;c.findWhere(this.gachaScheduleList,f)?c.each(this.gachaScheduleList,function(a,b){if(a.id==f.id||a.gachaType==f.gachaType)this.gachaIndex=b}.bind(this)):new b.PopupClass({title:"Not in Session",content:"You cannot draw this Fate Weave at this time.",closeBtnText:"OK",popupType:"typeC"})}this.template=c.template(w);this.createDom()},render:function(){this.$el.html(this.template(m));return this},createDom:function(){b.setGlobalView();
b.content.append(this.render().el);this.createView();this.gachaView.sdCharaInit();"NORMAL"===this.gachaModel.toJSON().gachaType?this.normalGachaStart():this.sdCharaStart();g.getBaseData(b.getNativeObj());b.ready.hide()},createView:function(){r.prototype.parentView=this;r.prototype.template=c.template($("#GachaTemp").text());this.gachaModel=new u(this.gachaScheduleList[this.gachaIndex]);this.gachaView=new r({model:this.gachaModel});b.doc.querySelector("#GachaTop").appendChild(this.gachaView.render().el);
if("PICKUP"===this.gachaModel.toJSON().gachaType||"ATTRIBUTE"===this.gachaModel.toJSON().gachaType){b.addClass(b.doc.getElementById("gachaDate"),"onDisp");var a=q.dst(new Date(this.gachaModel.attributes.endAt))?" PDT":" PST";b.doc.querySelector("#gachaDate").textContent="Available Until "+this.getDate(new Date(this.gachaModel.attributes.endAt))+a}},gachaChange:function(a,e){if(a){a.preventDefault();if(b.isScrolled())return;e=a.currentTarget;e="rightArrow"==e.id?1:-1}b.selectableCharaData=null;b.selectableChara=
null;b.selectableGachaModel=null;a=this.gachaScheduleList.length;this.gachaIndex+=e;this.gachaIndex===a&&(this.gachaIndex=0);0>this.gachaIndex&&(this.gachaIndex=a-1);this.gachaModel.clear({silent:!0});this.gachaModel.set(this.gachaScheduleList[this.gachaIndex]);console.log("gachaModel:",this.gachaModel.toJSON());if("PICKUP"===this.gachaModel.toJSON().gachaType||"ATTRIBUTE"===this.gachaModel.toJSON().gachaType)b.addClass(b.doc.getElementById("gachaDate"),"onDisp"),e=q.dst(new Date(this.gachaModel.attributes.endAt))?
" PDT":" PST",b.doc.querySelector("#gachaDate").textContent="Available Until "+this.getDate(new Date(this.gachaModel.attributes.endAt))+e;this.resetCmd();this.gachaView.sdCharaInit();"NORMAL"===this.gachaModel.toJSON().gachaType?this.normalGachaStart():this.sdCharaStart();g.getBaseData(b.getNativeObj())},charaImageAnimationEnd:function(a){if(1!==this.gachaView.dispCharaDataList.length){this.gachaView.dispCharaDataList.length>this.gachaView.dispCharaIndex+1?this.gachaView.dispCharaIndex++:this.gachaView.dispCharaIndex=
0;b.removeClass(b.doc.querySelector(".onDisp"),"onDisp");b.addClass(b.doc.querySelector("#card"+this.gachaView.dispCharaIndex),"onDisp");a=this.gachaView.dispCharaDataList[this.gachaView.dispCharaIndex];var e=b.doc.querySelector("#attribute span"),f=b.doc.querySelector("#rare"),l=b.doc.querySelector("#charaName"),d=b.doc.querySelector("#charaTitle");if("PICKUP"===this.gachaModel.toJSON().gachaType||"ATTRIBUTE"===this.gachaModel.toJSON().gachaType){b.addClass(b.doc.getElementById("gachaDate"),"onDisp");
var c=q.dst(new Date(this.gachaModel.attributes.endAt))?" PDT":" PST";b.doc.querySelector("#gachaDate").textContent="Available Until "+this.getDate(new Date(this.gachaModel.attributes.endAt))+c}a&&(e.className="type_f "+a.attributeId,f.className=a.rank,l.innerText=a.cardName,d.innerText=a.title||"",this.sdCharaStart())}},resetCmd:function(){k&&clearTimeout(k);h&&clearTimeout(h);g.stopNormalGachaMemoria();this.gachaView.dispCharaIndex=0;g.hideMiniChara()},normalGachaStart:function(){var a={x:640};
a.y=Math.floor(b.doc.getElementsByTagName("body")[0].offsetHeight/2)+80;a.memoriaIdList=function(){var a=[];c.each(this.gachaModel.toJSON().displayPieceList,function(b){a.push(b.pieceId)});return a}.call(this);k&&clearTimeout(k);k=setTimeout(function(){g.playNormalGachaMemoria(a)},500)},sdCharaStart:function(){h&&clearTimeout(h);if(!(0>=this.gachaView.dispCharaDataList.length||"SPECIAL"===this.gachaModel.toJSON().gachaType||"STARTDASH"===this.gachaModel.toJSON().gachaType)){var a={};a.id=String(this.gachaView.dispCharaDataList[this.gachaView.dispCharaIndex].charaNo+
"00");"SELECTABLE_TUTORIAL"===this.gachaModel.toJSON().gachaType||"SELECTABLE_PICKUP"===this.gachaModel.toJSON().gachaType||"SELECTABLE_SPECIAL"===this.gachaModel.toJSON().gachaType?a.y=Math.floor(b.doc.getElementsByTagName("body")[0].offsetHeight/2)+210:a.y=Math.floor(b.doc.getElementsByTagName("body")[0].offsetHeight/2)+170;a.x=221;a.fade=.5;a.animeList=["reaction","stance"];g.hideMiniChara();h=setTimeout(function(){g.showMiniChara(a);if("PICKUP"===this.gachaModel.toJSON().gachaType||"ATTRIBUTE"===
this.gachaModel.toJSON().gachaType||"TYPE"===this.gachaModel.toJSON().gachaType)h=setTimeout(function(){this.charaImageAnimationEnd()}.bind(this),7500)}.bind(this),500)}},getDate:function(a){var b=a.getMonth()+1,c=a.getDate(),l=a.getHours();a=a.getMinutes();var d=12<=l?"PM":"AM",l=l%12;return b+"/"+c+" "+(l?l:12)+":"+(10>a?"0"+a:a)+" "+d}}),r=n.View.extend({id:"gachaWrap",className:function(){var a="",b=this.model.toJSON(),a=a+b.gachaType;-1!==b.gachaType.indexOf("SELECTABLE")&&(this.selectableCardId||
(a+=" notSelectedChara"));return a},events:function(){var a={};a[b.cgti+" #charaSelectBtn"]=this.selectableLink;a[b.cgti+" #selectableLinkBtn"]=this.selectableLink;a[b.cgti+" #selectablePopBtn"]=this.selectableCharaListPop;return a},initialize:function(a){this.listenTo(this.parentView,"removeView",this.removeView);this.listenTo(this.model,"change",this.render);this.listenTo(b.storage.userItemList,"change",this.btnReCreate);p.prototype.parentView=this;p.prototype.template=c.template($("#GachaBtnTemp").text());
t.prototype.parentView=this;t.prototype.template=c.template($("#GachaFooterTemp").text());this.charaDataTemp=c.template($("#CharaDataTemp").text());this.dispCharaIndex=0;this.dispCharaDataList=[]},btnReCreate:function(){this.trigger("removeBtnView");this.trigger("removeFooterView");this.createBtnViews();this.createFooterView()},sdCharaInit:function(){this.dispCharaDataList=[];var a=this.model.toJSON();$(b.doc.querySelector("#charaData")).html();-1!==a.gachaType.indexOf("SELECTABLE")?this.selectableCardId&&
(a=c.findWhere(a.selectableCharaList,{defaultCardId:this.selectableCardId}),a={attack:a.defaultCard.attack,attributeId:a.attributeId,cardId:a.defaultCardId,cardName:a.name,charaNo:a.id,defense:a.defaultCard.defense,growthType:a.growthType,hp:a.defaultCard.hp,initialType:a.initialType,miniCharaNo:a.defaultCard.miniCharaNo,rank:a.defaultCard.rank,title:a.title},this.dispCharaDataList.push(a),b.selectableCharaData=a):0<a.displayCardList.length&&"SPECIAL"!==a.gachaType&&"STARTDASH"!==a.gachaType&&"ATTRIBUTE"!==
a.gachaType&&"TYPE"!==a.gachaType&&(this.dispCharaDataList=c.clone(a.displayCardList));0<this.dispCharaDataList.length&&(b.removeClass(b.doc.querySelector("#charaData"),"hide"),$(b.doc.querySelector("#charaData")).html(this.charaDataTemp({model:this.dispCharaDataList[this.dispCharaIndex]})),1===this.dispCharaDataList.length&&b.addClass(b.doc.querySelector("#card"+this.dispCharaIndex),"singleCard"),b.addClass(b.doc.querySelector("#card"+this.dispCharaIndex),"onDisp"))},createBtnViews:function(){this.trigger("removeBtnView");
var a=this.model.toJSON(),e=b.doc.createDocumentFragment(),f=b.getTotalStone();c.each(a.gachaKindList,function(a,d){console.log("kind:",a);d=null;if(a.substituteItemId){var c=b.storage.userItemList.findWhere({itemId:a.substituteItemId});d=c?c.toJSON():null;c&&(d.subItemFlag=!0);d=d&&0<d.quantity?d:!1}-1!==a.displayTitle.indexOf("＠")&&(a.displayTitle=a.displayTitle.replace(/＠/g,"\x3cbr\x3e"));if(!d)switch(a.needPointKind){case "PURCHASED_MONEY":d={item:{name:"Paid Magia Stone",shortDescription:"Paid Magia Stone",
itemCode:"PURCHASED_MONEY",unit:""},quantity:f.userMoney,moneyObj:f};break;case "MONEY":d={item:{name:"Magia Stone",shortDescription:"Magia Stone",itemCode:"MONEY",unit:""},quantity:f.totalMoney,moneyObj:f};break;case "YELL":d=(d=b.storage.userItemList.findWhere({itemId:"YELL"}))?d.toJSON():{item:{name:"Support Pt",shortDescription:"Support Pt",itemCode:"YELL",unit:"Pt"},quantity:0};break;case "ITEM":d=(d=b.storage.userItemList.findWhere({itemId:a.itemId}))?d.toJSON():{item:a.item,quantity:0}}a.userUseItem=
d;a=new p({model:new u(a)});e.appendChild(a.render().el)});this.el.querySelector("#gachaBtnWrap").appendChild(e)},createFooterView:function(){this.trigger("removeFooterView");var a=new t({model:this.model});this.el.appendChild(a.render().el)},render:function(){var a=this.model.toJSON();this.selectableCardId=null;-1!==a.gachaType.indexOf("SELECTABLE")&&(!b.selectableChara&&a.gachaGroup&&a.gachaGroup.cardId||b.selectableChara&&b.selectableChara.cardId&&b.selectableChara.gachaId===a.id)&&(this.selectableCardId=
b.selectableChara?b.selectableChara.cardId:a.gachaGroup&&a.gachaGroup.cardId?a.gachaGroup.cardId:null);"STARTDASH"===a.gachaType&&(a=b.getTimeText(m.gameUser.startdashGachaExpiredAt,!0),this.model.set({startdashGachaExpiredAt:a},{silent:!0}));this.$el.html(this.template({model:this.model.toJSON()}));this.el.className=this.className();this.createBtnViews();this.createFooterView();return this},selectableLink:function(a){a.preventDefault();b.isScrolled()||(b.selectableGachaModel=this.model.toJSON(),
location.href="#/SelectableGachaCharaSelect")},selectableCharaListPop:function(a){a.preventDefault();b.isScrolled()||(a=$("#selectablePop").text(),new b.PopupClass({popupType:"typeA",exClass:"selectableCharaListPop",charaList:this.model.toJSON().selectableCharaList},a,function(){g.getBaseData(b.getNativeObj());b.scrollSet("scrollOuter","scrollInner")}))},removeView:function(){this.trigger("removeBtnView");this.trigger("removeFooterView");this.trigger("removeView");$("#popupArea").off();k&&clearTimeout(k);
h&&clearTimeout(h);g.stopNormalGachaMemoria();g.hideMiniChara();this.off();this.remove()}}),t=n.View.extend({id:"gachaFooterWrap",events:function(){var a={};a[b.cgti+" #probabilityBtn"]=this.gachaProbabilityPop;a[b.cgti+" #purchaseMoneyBtn"]=this.purchaseMoneyPop;return a},initialize:function(a){this.listenTo(this.parentView,"removeFooterView",this.removeView);this.probabilityDispFlag=this.historyDispFlag=!0;switch(this.model.toJSON().gachaType){case "SELECTABLE_TUTORIAL":this.probabilityDispFlag=
this.historyDispFlag=!1;break;case "SELECTABLE_SPECIAL":this.probabilityDispFlag=this.historyDispFlag=!1;break;case "NORMAL":this.probabilityDispFlag=!1}this.gachaGroupCount=this.hasItemTxt=this.hasItemNum=this.useItemType=null;switch(this.model.toJSON().gachaType){case "PICKUP":case "ATTRIBUTE":case "TYPE":case "RARE":case "STARTDASH":case "SELECTABLE_PICKUP":this.useItemType="MONEY";this.hasItemNum=b.getTotalStone().totalMoney;a=this.model.toJSON();this.gachaGroupCount=a.gachaGroup?a.gachaGroup.count:
0;this.hasItemTxt="Stock";break;case "NORMAL":this.useItemType="YELL",this.hasItemNum=(a=b.storage.userItemList.findWhere({itemId:"YELL"}))?a.toJSON().quantity:0,this.hasItemTxt="Stock"}},render:function(){this.$el.html(this.template());return this},gachaProbabilityPop:function(a){a.preventDefault();if(!b.isScrolled()){var c=this.model.toJSON();x.init(a,c.id,c.gachaType,this.parentView.parentView.gachaScheduleList)}},purchaseMoneyPop:function(a){a.preventDefault();b.isScrolled()||b.globalMenuView.moneyPopup(a)},
removeView:function(){console.log("footerRemove");this.off();this.remove()}});return y});