define(["underscore","backbone","backboneCommon","ajaxControl","command"],function(r,y,a,k,g){var h,m,t,u,q,l,n,f=!1,p=function(b,d){m=h=null;f=!1;d&&(h=d);b&&(m=b);new a.PopupClass({title:"Restore AP",content:"",exClass:"apPopup",popupType:"typeB"});a.doc.createDocumentFragment();var c=a.doc.createElement("div"),e={};b=a.storage.userItemList;b.findWhere({itemId:"CURE_AP_50"})?e.ap50=b.findWhere({itemId:"CURE_AP_50"}).toJSON():e.ap50={quantity:0};b.findWhere({itemId:"CURE_AP"})?e.apMax=b.findWhere({itemId:"CURE_AP"}).toJSON():
e.apMax={quantity:0};require(["text!template/user/APPopup.html"],function(b){t=r.template(b);c.innerHTML=t({model:e,userItemList:a.storage.userItemList,message:m});a.doc.getElementById("popupArea").getElementsByClassName("popupTextArea")[0].appendChild(c);q=a.storage.userStatusList.findWhere({statusId:"ACP"}).toJSON().point;l=a.storage.userStatusList.findWhere({statusId:"MAX_ACP"}).toJSON().point;q>=l&&v();a.doc.getElementById("popupArea").getElementsByClassName("popACP")[0].textContent=q;a.doc.getElementById("popupArea").getElementsByClassName("popMAX_ACP")[0].textContent=
l;a.doc.getElementById("useItemWrap").addEventListener(a.cgti,w)})},w=function(b){if(b.target.classList.contains("cureBtn")&&!b.target.classList.contains("off")&&!a.isScrolled()){b.preventDefault();a.globalMenuView&&a.globalMenuView.awakeSuspend();n=b.target.dataset.item;new a.PopupClass({title:"Restore AP",content:"",exClass:"apPopup",popupType:"typeC"});a.doc.createDocumentFragment();var d=a.doc.createElement("div"),c={};c.nowACP=a.storage.userStatusList.findWhere({statusId:"ACP"}).toJSON().point;
c.nowMAX=a.storage.userStatusList.findWhere({statusId:"MAX_ACP"}).toJSON().point;var e=a.storage.userItemList;switch(n){case "CURE_AP_50":c.itemName="AP 50 Potion";c.after=(c.nowACP|0)+50;c.quantity=e.findWhere({itemId:"CURE_AP_50"}).toJSON().quantity;break;case "CURE_AP":c.itemName="AP Potion";c.after=(c.nowACP|0)+(l|0);c.quantity=e.findWhere({itemId:"CURE_AP"}).toJSON().quantity;break;case "MONEY":c.itemName="Magia Stones",c.after=(c.nowACP|0)+(l|0),b=e.findWhere({itemId:"PRESENTED_MONEY"})?e.findWhere({itemId:"PRESENTED_MONEY"}).toJSON().quantity:
0,e=e.findWhere({itemId:"MONEY"})?e.findWhere({itemId:"MONEY"}).toJSON().quantity:0,c.quantity=b+e|0}require(["text!template/user/APPopup2.html"],function(b){u=r.template(b);d.innerHTML=u({model:a.storage,item:c});a.doc.getElementById("popupArea").getElementsByClassName("popupTextArea")[0].appendChild(d);a.doc.getElementById("confirmBtns").addEventListener(a.cgti,x)})}},x=function(b){b.preventDefault();a.isScrolled()||!b.target.classList.contains("btn")||f||(f=!0,"cancel"===b.target.dataset.action?
(f=!1,p(m,h)):"MONEY"===n?(b=function(b){"error"!==b.resultCode&&(b=JSON.parse(b),a.responseSetStorage(b),void 0!==a.noticeAp&&!0===a.noticeAp?g.noticeApFullSet(0):void 0===a.noticeAp&&($("#configCallback").on("configCallback",function(b,d){$("#configCallback").off();a.noticeAp=1===d.ap?!0:!1;a.noticeAp&&g.noticeApFullSet(0)}),g.noticeApConfig("configCallback")),h?(a.g_popup_instance&&a.g_popup_instance.popupView.close(),f=!1,h()):(f=!1,p()))},k.ajaxPlainPost(a.linkList.useMoneyProcess,"COMMAND_TYPE\x3d2\x26ITEM_TYPE\x3d1\x26ITEM_NUMBER\x3d1",
b)):(b=function(b){if("error"!==b.resultCode){a.responseSetStorage(b);if(void 0!==a.noticeAp&&!0===a.noticeAp){if(!a.storage.userStatusList||!k.getPageJson().currentTime)return;b=a.storage.userStatusList.findWhere({statusId:"ACP"}).toJSON();var c=a.storage.userStatusList.findWhere({statusId:"MAX_ACP"}).toJSON();b.point>=c.point?g.noticeApFullSet(0):(b=a.getApRemainTime(b,c,k.getPageJson().currentTime),g.noticeApFullSet(b))}else void 0===a.noticeAp&&($("#configCallback").on("configCallback",function(b,
c){$("#configCallback").off();a.noticeAp=1===c.ap?!0:!1;a.noticeAp&&(b=a.storage.userStatusList.findWhere({statusId:"ACP"}).toJSON(),c=a.storage.userStatusList.findWhere({statusId:"MAX_ACP"}).toJSON(),b=a.getApRemainTime(b,c,k.getPageJson().currentTime),g.noticeApFullSet(b))}),g.noticeApConfig("configCallback"));h?(a.g_popup_instance&&a.g_popup_instance.popupView.close(),f=!1,h()):(f=!1,p())}},k.ajaxPost(a.linkList.useItem,{itemId:n,num:1},b)))},v=function(){for(var b=a.doc.getElementById("useItemWrap").getElementsByClassName("cureBtn"),
d=b.length;0<d;)d=d-1|0,a.addClass(b[d],"off");a.addClass(a.doc.querySelector(".maxTime"),"none");a.removeClass(a.doc.querySelector("#apPointWrap"),"timeShow")};return{instantPopup:function(a,d){p(a,d)},apCureEvents:function(){var b=a.storage.userStatusList,d;d=b.findWhere({statusId:"ACP"}).toJSON().point;b=b.findWhere({statusId:"MAX_ACP"}).toJSON().point;a.doc.getElementById("apPointWrap").getElementsByClassName("popACP")[0].textContent=d;a.doc.getElementById("apPointWrap").getElementsByClassName("popMAX_ACP")[0].textContent=
b;d>=b&&v()}}});