define("underscore backbone backboneCommon ajaxControl command text!template/memoria/MemoriaSetEquip.html text!css/memoria/MemoriaSetEquip.css memoriaUtil cardUtil js/memoria/MemoriaPopup".split(" "),function(g,m,a,k,n,x,y,u,z,l){var v=m.Model.extend({}),w,p,A=m.View.extend({initialize:function(a){this.template=g.template(x);this.createDom()},render:function(){this.$el.html(this.template(k.getPageJson()));return this},createDom:function(){a.setGlobalView();a.content.append(this.render().el);var b=
$.extend(!0,{},a.equipInfo);q.prototype.parentView=this;q.prototype.template=g.template($("#EquipDetail").text());var c=a.doc.createDocumentFragment();this.equipDetailView=new q({model:new v(b)});c.appendChild(this.equipDetailView.render().el);a.doc.querySelector("#MemoriaSetEquip").appendChild(c);this.setListCreate();a.scrollSet("scrollOuter","scrollInner");a.firstNaviCheck(w);a.ready.hide()},setListCreate:function(){r.prototype.parentView=this;r.prototype.template=g.template($("#memoriaSetListTemp").text());
for(var b=a.storage.userPieceSetList.toJSON(),c=a.doc.createDocumentFragment(),f=a.storage.userCardListEx.findWhere({charaId:a.equipInfo.charaId}).toJSON(),e=0;20>e;){var h=b.filter(function(a){return a.setNum==e+1})[0]||{setNum:e+1,name:"Memoria Set"+(e+1)},d={name:h.name,setNum:h.setNum,setNumDisp:("00"+h.setNum).slice(-2),pieceArr:[],hp:0,attack:0,defense:0};d.name&&""!=d.name||(d.name="Memoria Set"+d.setNum);var t=f.revision+1;g.each(h,function(b,c){if(-1!==c.indexOf("userPieceId"))if(c=Number(c.split("userPieceId")[1])-
1,d.pieceArr[c]=a.storage.userPieceList.findWhere({id:b}).toJSON(),d.pieceArr[c]){d.pieceArr[c].maxLevel=u.getMaxLevel(d.pieceArr[c].piece.rank,d.pieceArr[c].lbCount);d.hp+=d.pieceArr[c].hp;d.attack+=d.pieceArr[c].attack;d.defense+=d.pieceArr[c].defense;var h=!1;d.pieceArr[c].piece.charaList&&g.each(d.pieceArr[c].piece.charaList,function(a,b){a.charaId!==f.charaId&&(h="cantEquipChara")});"ALL"!==d.pieceArr[c].piece.attributeId&&d.pieceArr[c].piece.attributeId!==f.chara.attributeId&&(h="cantEquipAtt");
0>=t&&(h="cantEquip");t--;d.pieceArr[c].invalidFlag=h}else t--});h=new r({model:new v(d)});c.appendChild(h.render().el);e=e+1|0}a.doc.querySelector("#scrollInner").appendChild(c);n.getBaseData(a.getNativeObj())}}),r=m.View.extend({className:"setWrap commonFrame3",events:function(){var b={};b[a.cgti+" .memoriaSetEquipBtn"]=this.equipConf;b[a.cgti+" .memoriaSetBtn"]=this.setConf;b["touchstart .equip"]=this.popupTimeStart;b[a.cgti+" .equip"]=this.popupTimeStop;b[a.cgti+" .nameChangeBtn"]=this.nameChange;
return b},initialize:function(a){this.listenTo(this.model,"change",this.render);this.listenTo(this.parentView,"removeView",this.removeView)},render:function(){this.$el.html(this.template({model:this.model.toJSON()}));return this},popupTimeStart:function(b){var c=this.model.toJSON().pieceArr[b.currentTarget.dataset.framenum];c&&(c=a.storage.userPieceList.findWhere({id:c.id}).toJSON(),l.cardDetailPopup(b,c))},popupTimeStop:function(a){l.popupTimerStop()},setConf:function(b){b.preventDefault();if(!a.isScrolled()){var c=
this;this.model.toJSON().pieceArr.length?(b="\x3cp\x3eOverwrite ["+this.model.toJSON().name+"]?\x3c/br\x3e",new a.PopupClass({title:"Overwrite Memoria Set",content:b+"Are you sure?\x3c/p\x3e",decideBtnText:"OK",closeBtnText:"Cancel",exClass:"setEquipConf"},null,function(){$("#popupArea .decideBtn").on(a.cgti,function(b){b.preventDefault();a.isScrolled()||($("#popupArea .decideBtn").off(),c.setFunc(),a.g_popup_instance.remove())})})):c.setFunc()}},setFunc:function(){var b=this,c=this.model.toJSON(),
f=this.parentView.equipDetailView.model.toJSON().pieceArr,e={setNum:c.setNum,name:c.name,userPieceIdList:[]};g.each(f,function(a){a&&a.id&&e.userPieceIdList.push(a.id)});k.ajaxPost(a.linkList.userPieceSetSave,e,function(c){a.responseSetStorage(c);var d={name:c.userPieceSetList[0].name,setNum:c.userPieceSetList[0].setNum,setNumDisp:("00"+c.userPieceSetList[0].setNum).slice(-2),pieceArr:[],hp:0,attack:0,defense:0};d.name&&""!=d.name||(d.name="Memoria Set"+d.setNum);g.each(c.userPieceSetList[0],function(b,
c){-1!==c.indexOf("userPieceId")&&(c=Number(c.split("userPieceId")[1])-1,d.pieceArr[c]=a.storage.userPieceList.findWhere({id:b}).toJSON(),d.pieceArr[c]&&(d.pieceArr[c].maxLevel=u.getMaxLevel(d.pieceArr[c].piece.rank,d.pieceArr[c].lbCount),d.hp+=d.pieceArr[c].hp,d.attack+=d.pieceArr[c].attack,d.defense+=d.pieceArr[c].defense))});b.model.set(d);n.getBaseData(a.getNativeObj());b.parentView.equipDetailView.changeSetMode()})},equipConf:function(b){b.preventDefault();if(!a.isScrolled()){var c=this;console.log(this.model.toJSON());
b="\x3cp\x3eThis will Unequip your current Memoria,\x3c/br\x3e"+("and Equip ["+this.model.toJSON().name+"].\x3c/br\x3e");new a.PopupClass({title:"Memoria Set",content:b+'Are you sure?\x3c/p\x3e\x3cp class\x3d"c_red"\x3eâ€»When an equipped Memoria is included, that\x3c/br\x3eMemoria will be unequipped from its Magical Girl.\x3c/p\x3e',decideBtnText:"OK",closeBtnText:"Cancel",exClass:"setEquipConf"},null,function(){$("#popupArea .decideBtn").on(a.cgti,function(b){b.preventDefault();a.isScrolled()||($("#popupArea .decideBtn").off(),
c.equipFunc())})})}},equipFunc:function(){var b=this.model.toJSON(),c=b.pieceArr,f=a.equipInfo.posIndex,e=null;g.each(a.holdDeck,function(a,b){-1!==b.indexOf("questPositionId")&&a==f&&(e="userPieceId"+("00"+b.split("questPositionId")[1]).slice(-2))});g.each(b.pieceArr,function(b,c){g.each(a.holdDeck,function(c,d){(b&&c==b.id&&-1!==d.indexOf("userPieceId")||-1!==d.indexOf(e))&&delete a.holdDeck[d]})});for(b=0;4>b;)c[b]&&c[b].id&&(a.holdDeck[e+(b+1)]=c[b].id),b=b+1|0;a.backLinkHandler()},nameChange:function(b){b.preventDefault();
if(!a.isScrolled()){var c=this;b=$("#SetNameChangeTemp").text();var f=this.model.toJSON();f.exClass="setNameChangePop";var e=new a.PopupClass(f,b,function(){a.nativeKeyBoard("commentInput",15,null,"textCount");a.doc.getElementById("commentDecide").addEventListener(a.cgti,function(b){b.preventDefault();if(!a.isScrolled()){a.tapBlock(!0);var d={setNum:f.setNum,name:a.doc.getElementById("commentInput").value,userPieceIdList:[]};g.each(f.pieceArr,function(a){a&&a.id&&d.userPieceIdList.push(a.id)});k.ajaxPost(a.linkList.userPieceSetSave,
d,function(b){a.responseSetStorage(b);c.model.set({name:a.doc.getElementById("commentInput").value});n.getBaseData(a.getNativeObj());e.remove();a.tapBlock(!1)})}});a.doc.getElementById("defaultNameBtn").addEventListener(a.cgti,function(b){b.preventDefault();a.isScrolled()||(a.doc.getElementById("commentInput").value="Memoria Set"+f.setNum,a.doc.getElementById("textCount").textContent=String("Memoria Set"+f.setNum).length)})})}},removeView:function(){this.off();this.remove()}}),q=m.View.extend({id:"equipDetailWrap",
events:function(){var b={};b[a.cgti+" #mainBtn"]=this.changeSetMode;b["touchstart .equip"]=this.popupTimeStart;b[a.cgti+" .equip"]=this.popupTimeStop;return b},initialize:function(a){this.listenTo(this.parentView,"removeView",this.removeView)},render:function(){this.$el.html(this.template({model:this.model.toJSON()}));n.getBaseData(a.getNativeObj());return this},popupTimeStart:function(b){var c=this.model.toJSON().pieceArr[b.currentTarget.dataset.framenum];c&&(c=a.storage.userPieceList.findWhere({id:c.id}).toJSON(),
l.cardDetailPopup(b,c))},popupTimeStop:function(a){l.popupTimerStop()},changeSetMode:function(b){if(b&&(b.preventDefault(),a.isScrolled()))return;b=a.doc.querySelector("#MemoriaSetEquip");b.classList.contains("typeSet")?(b.querySelector("h2").textContent="Select the Set you want to Equip.",a.removeClass(b,"typeSet")):(b.querySelector("h2").textContent="Select the Set you want to Register.",a.addClass(b,"typeSet"))},removeView:function(){this.off();this.remove()}});return{needModelIdObj:[{id:"user"},
{id:"gameUser"},{id:"userItemList"},{id:"userStatusList"},{id:"userCharaList"},{id:"userCardList"},{id:"userDoppelList"},{id:"userLive2dList"},{id:"userPieceList"},{id:"userPieceSetList"},{id:"userPieceSetList"},{id:"userDeckList"}],fetch:function(){k.pageModelGet(this.needModelIdObj)},init:function(){a.equipInfo?(z.createCardList(),a.setStyle(y),w=k.getPageJson(),p=new A):location.href="#/MyPage"},startCommand:function(){},removeCommand:function(){},remove:function(a){l.popupTimerStop();p&&(p.trigger("removeView"),
p.remove());a()}}});