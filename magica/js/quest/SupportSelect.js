define("underscore backbone backboneCommon ajaxControl command QuestUtil js/card/CardPopup text!template/quest/SupportSelect.html text!css/quest/SupportSelect.css cardUtil".split(" "),function(k,r,a,u,p,Q,B,D,E,v){var w=r.Model.extend(),q,c,m,H=r.View.extend({events:function(){var b={};b[a.cgti+" #tabArea .tabBtn"]=this.tabFunc;b[a.cgti+" #friendSortBtn"]=this.sortFunc;b[a.cgti+" #friendAscBtn"]=this.ascFunc;b[a.cgti+" #eventFilterBtn"]=this.eventFilterFunc;return b},initialize:function(a){this.template=
k.template(D);this.createDom()},render:function(){this.$el.html(this.template(c));return this},createDom:function(){a.setGlobalView();a.content.append(this.render().el)},tabFunc:function(b){b.preventDefault();a.isScrolled()||(f[2]=b.currentTarget.dataset.att,a.sfml[l]=f,a.sfm(),C(f))},sortFunc:function(b){b.preventDefault();a.isScrolled()||(f[0]=F[b.currentTarget.dataset.id],a.sfml[l]=f,a.sfm(),x(f))},ascFunc:function(b){b.preventDefault();a.isScrolled()||(f[1]=G[b.currentTarget.dataset.id],a.sfml[l]=
f,a.sfm(),x(f))},eventFilterFunc:function(b){b.preventDefault();a.isScrolled()||(b=b.currentTarget.classList.contains("on")?"off":"on",f[3]=b,a.sfml[l]=f,a.sfm(),y(f))}}),z=r.View.extend({id:"questDetail",events:function(){var b={};b[a.cgti+" #dropItemBtn"]=this.dropItemShow;b[a.cgti+" #dropDetailClose"]=this.dropItemHide;b[a.cgti+" .dropList img"]=this.dropItemNameShow;return b},initialize:function(a){this.listenTo(this.parentView,"removeView",this.removeView)},render:function(){this.$el.html(this.template({model:this.model.toJSON()}));
return this},dropItemShow:function(b){b.preventDefault();if(!a.isScrolled()){b=this.el.querySelector(".questDetail");var h=this.el.querySelector(".dropDetail");b.className="questDetail hide";h.className="dropDetail show"}},dropItemHide:function(b){b.preventDefault();if(!a.isScrolled()){b=this.el.querySelector(".questDetail");var h=this.el.querySelector(".dropDetail");b.className="questDetail show";h.className="dropDetail hide"}},dropItemNameShow:function(b){b.preventDefault();a.isScrolled()||(a.removeClass(a.doc.querySelector(".dropList .show"),
"show"),setTimeout(function(){a.addClass(b.currentTarget.parentNode,"show")},10))},removeView:function(){this.off();this.remove()}}),t=r.View.extend({initialize:function(){this.popupInitFlag=!1;this.listenTo(this.parentView,"removeView",this.removeView)},className:function(){var a="wrap ";this.model.toJSON().tapBlock&&(a+="tapBlock ");this.model.toJSON().isNpc&&(a+="npcChara ");this.model.toJSON().bonusMemoriaFlag&&(a+="bonusIcon ");return a},events:function(){var b={};b[a.cgti+" .magiaWrap"]=this.supportDecide;
b[a.cgti+" .skillBox"]=this.supportDecide;b[a.cgti+" .tapArea"]=this.supportDecide;b["touchstart .magiaWrap"]=this.popupTimeStart;b["touchstart .skillBox"]=this.popupTimeStart;b["touchstart .tapArea"]=this.popupTimeStart;return b},popupTimeStart:function(b){if(!a.tutorialId&&!this.model.toJSON().isNpc&&this.model.toJSON().card&&"Not Set"!=this.model.toJSON().card.cardName){var h=this,g=a.storage.userCardListEx.findWhere({id:this.model.toJSON().id}),g=g?g.toJSON():this.model.toJSON();b.currentTarget.classList.contains("skillBox")&&
(g.initTabType="memoria");b.currentTarget.classList.contains("magiaWrap")&&(g.initTabType="skill");g.deckFormationFlag=!0;B.cardDetailPopup(b,g,function(){if(a.storage.userCardListEx){var b=a.storage.userCardListEx.findWhere({id:h.model.toJSON().id}),b=b?b.toJSON():h.model.toJSON();h.model.set({displayCardId:b.displayCardId});p.getBaseData(a.getNativeObj())}})}},render:function(){this.$el.html(this.template({model:this.model.toJSON()}));this.model.toJSON().filterAtt&&a.addClass(this.el,this.model.toJSON().filterAtt);
return this},supportDecide:function(b){a.detailView||(b.preventDefault(),B.popupTimerStop(b),a.isScrolled()||(a.tutorialId?(p.startSe(1001),a.tutorialUtil[a.tutorialId]()):this.model.toJSON().tapBlock||(p.startSe(1002),a.questSupportModel=this.model.toJSON(),a.questSupportModel.supportTabAtt=a.doc.querySelector("#tabArea .current").dataset.att,location.href="#/DeckFormation/quest")))},removeView:function(){this.off();this.remove()}}),n={},l="SupportSelect",f=a.sfml[l]||["userRank","desc","all","off"],
I=["TOWER","DAILYTOWER","BRANCH","SINGLERAID"],L=function(){q=1;n=a.questBattleModel||{chapterNo:0,genericIndex:0,ap:0,title:"-",questBattle:{difficulty:0,npcHelpNameHidden:!1,npcHelpNameQuestHidden:!1,npcHelpDisplayHidden:!1,npcHelpSupportHidden:!1}};a.questSupportModel=null;v.createCardList();c=u.getPageJson();c.supportUserList&&(a.supportUserList=c.supportUserList.concat());c.bonusEventFlag=!1;if(c.campaignList){var b=a.campaignParse(c.campaignList);if(b.POINT_UP&&a.questBattleModel&&a.questBattleModel.questType&&
b.POINT_UP.YELL)if(b.POINT_UP.YELL[a.questBattleModel.questType])q=b.POINT_UP.YELL[a.questBattleModel.questType];else if(b.POINT_UP.YELL.ALL)switch(a.questBattleModel.questType){case "MAIN":case "SUB":case "CHARA":case "COSTUME":case "COMPOSE":case "MATERIAL":q=b.POINT_UP.YELL.ALL}}c.eventList&&k.each(c.eventList,function(a){0<=I.indexOf(a.eventType)&&(c.bonusEventFlag=!0)});a.setStyle(E);m=new H;J();K();p.getBaseData(a.getNativeObj());a.ready.hide()},C=function(b,h){b[2]||(b[2]="all",a.sfml[l]=b,
a.sfm());var g=b[2];a.doc.querySelector("#friendWrap").className=g;a.removeClass(a.doc.querySelector("#tabArea .current"),"current");a.addClass(a.doc.querySelector(".tabBtn."+g),"current");y(b,h)},y=function(b,h){if(c.bonusEventFlag){b[3]||(b[3]="off",a.sfml[l]=b,a.sfm());if("on"==b[3]&&c.bonusEventFlag){a.addClass(a.doc.querySelector("#friendWrap"),"eventFilter");a.addClass(a.doc.querySelector("#eventFilterBtn"),"on");var g="#friendWrap."+b[2]+" ."+b[2].toUpperCase()+".bonusIcon";a.doc.querySelector(g)?
a.removeClass(a.doc.querySelector(".supportCation"),"on"):a.addClass(a.doc.querySelector(".supportCation"),"on")}"off"==b[3]&&c.bonusEventFlag&&(a.removeClass(a.doc.querySelector("#friendWrap"),"eventFilter"),a.removeClass(a.doc.querySelector("#eventFilterBtn"),"on"))}h||a.scrollRefresh(null,null,!0)},F={level:"atk",atk:"def",def:"hp",hp:"userRank",userRank:"level"},M={level:"sortLv",atk:"sortAtk",def:"sortDef",hp:"sortHp",userRank:"sortRank"},G={asc:"desc",desc:"asc"},N={level:"Level",atk:"ATK",
def:"DEF",hp:"HP",userRank:"Rank"},x=function(b,h){if(b){var g="asc"===b[1]?-1:1,d=document.querySelector(".friendWrapInner");[].slice.call(d.querySelectorAll(".wrap")).map(function(a){var d=a.querySelector(".prm_"+b[0]).textContent|0,e=(a.querySelector(".prm_follow").textContent|0)+(a.querySelector(".prm_follower").textContent|0);return{dom:a,value:d,value2:e}}).sort(function(a,b){return b.value2<a.value2?-1:b.value2>a.value2?1:b.value<a.value?-1*g:b.value>a.value?1*g:0}).forEach(function(a){d.appendChild(a.dom)});
a.doc.querySelector("#friendSortBtn").dataset.id=b[0];a.doc.querySelector("#friendSortBtn").textContent=N[b[0]];a.doc.querySelector("#friendAscBtn").dataset.id=b[1];a.doc.querySelector("#friendAscBtn").className="se_tabs TE "+b[1];a.doc.querySelector(".friendWrapInner").className="friendWrapInner "+M[b[0]];y(b)}},O=function(a){var b=Date.parse(c.currentTime)/1E3;k.each(a,function(a){var d=a.lastAccessDate?Date.parse(a.lastAccessDate)/1E3:null;d?(d=(b-d)/60,16>d?d="15 Min(s) Ago":60>d?d=Math.floor(d)+
" Min(s) Ago":60<d&&1440>d?d=Math.floor(d/60)+" Hour(s) Ago":(d=d/60/24,d=30<d?Math.floor(d/30)+" Month(s) Ago":Math.floor(d)+" Day(s) Ago")):d="- Day(s) Ago";a.loginTimeLag=d});return a},K=function(){if(a.supportUserList||c.npcHelpList){t.prototype.parentView=m;t.prototype.template=k.template($("#FriendTemp").text());var b=[];a.supportUserList&&(b=O(a.supportUserList.concat()));c.npcHelpList&&Array.prototype.push.apply(b,c.npcHelpList);var h={1:"ALL",2:"FIRE",3:"WATER",4:"TIMBER",5:"LIGHT",6:"DARK"},
g=a.doc.createDocumentFragment();k.each(b,function(b){var d={ALL:null,FIRE:null,WATER:null,TIMBER:null,LIGHT:null,DARK:null},c={},e={};if(b.isNpc){console.log("-----------");console.log("npcModel:",b);c=$.extend(b.userCardList[0],b.userCharaList[0]);c.supportFlag=!0;c.isNpc=!0;var c=v.addExStatus(c,b.userPieceList,b.userDoppelList,b.userDeck),f=n.questBattle.npcHelpDisplayHidden;e.userName=n.questBattle.npcHelpNameHidden?"???":b.userName;e.loginTimeLag=b.loginTimeLag;e.userRank=b.userRank;e.follow=
b.follow;e.follower=b.follower;e.isNpc=!0;e.tapBlock=!1;e.faceHidden=f;e.yellFactor=q;c=$.extend(e,c);c=new t({model:new w(c)});g.appendChild(c.render().el)}else if(e={},!n.questBattle.npcHelpSupportHidden&&!a.tutorialId){var l={};k.each(b.userDeck,function(a,d){-1!==d.indexOf("questPositionId")&&(d=d.split("questPositionId")[1],l[h[a]]=b.userDeck["userCardId"+d])});k.each(l,function(a,c){k.each(b.userCardList,function(b){a==b.id&&(d[c]=b)})});k.each(b.userCharaList,function(a){k.each(h,function(c){d[c]&&
a.userCardId==d[c].id&&(d[c].supportFlag=!0,d[c].filterAtt=c,d[c]=v.addExStatus($.extend(d[c],a),b.userPieceList,b.userDoppelList,b.userDeck))})});e.userName=b.userName;e.loginTimeLag=b.loginTimeLag;e.userRank=b.userRank;e.follow=b.follow;e.follower=b.follower;e.yellFactor=q;e.resentUse=!1;e.follow&&(f=a.storage.userFollowList.findWhere({followUserId:b.userId}))&&f.toJSON().recentUsedAt&&(c=u.getPageJson().currentTime.split(" ")[0],f=f.toJSON().recentUsedAt.split(" ")[0],c===f&&(e.resentUse=!0,console.log("this user is recent use.",
e.userName)));e.definiteClassRank=b.definiteClassRank;k.each(h,function(a){e.tapBlock=!1;var b;a=d[a]||{filterAtt:a,card:{cardName:"Not Set"},tapBlock:!0};b=$.extend(!1,e,a);b=new t({model:new w(b)});("Not Set"==a.card.cardName||"ALL"==a.filterAtt||"ALL"!==a.filterAtt&&a.filterAtt==a.card.attributeId)&&g.appendChild(b.render().el)})}});a.doc.querySelector("#friendWrap .friendWrapInner").appendChild(g);a.scrollSet("friendWrap","friendWrapInner");x(f);C(f,!0)}},J=function(){z.prototype.parentView=m;
z.prototype.template=k.template($("#QuestDetailTemp").text());var b=new z({model:new w(n)});a.doc.querySelector("#SuppotSelect").appendChild(b.render().el);P();a.scrollSet("dropListWrap","dropList")},P=function(){a.questBattleModel&&k.each(a.questBattleModel.questBattle.waveEnemyAttributeIdList,function(b){b=b.toLowerCase();a.addClass(a.doc.querySelector(".enemyDetail ."+b),"on")})},A=null;return{needModelIdObj:[{id:"user"},{id:"gameUser"},{id:"itemList"},{id:"userItemList"},{id:"userStatusList"},
{id:"userCharaList"},{id:"userCardList"},{id:"userDeckList"},{id:"userDoppelList"},{id:"userLive2dList"},{id:"userPieceList"},{id:"userPieceSetList"}],fetch:function(b){A=b||null;b={};a.supportUserList||(b.strUserIds=a.strSupportPickUpUserIds);a.questBattleModel&&a.questBattleModel.questBattle.npcHelpId&&(b.strNpcHelpIds=String(a.questBattleModel.questBattle.npcHelpId));u.pageModelGet(this.needModelIdObj,null,b)},init:function(){if(A)if(a.tutorialId=A,a.tutorialUtil)a.tutorialUtil.tutorialIdRegist(a.tutorialId),
a.tutorialUtil.tutorialAddClass(a.tutorialId);else{p.nativeReload("#/TopPage");return}L()},remove:function(a){n={};m&&(m.trigger("removeView"),m.remove());a()}}});