define("backboneCommon ajaxControl command QuestUtil cardUtil memoriaUtil".split(" "),function(a,q,f,r,x,u){function v(d){if(d){d=d.webData;var b=d.userQuestBattleResultList[0].questBattle;a.responseSetStorage(d);if(d=(d=a.storage.userSectionList.findWhere({sectionId:b.sectionId}))?d.toJSON():null)b=(b=a.storage.userChapterList.findWhere({chapterId:d.section.genericId}))?b.toJSON():null,a.playChapter=b,a.playSection=d}}var n=function(a){this.deckCatType=a;this.questDisableFlg=!1};n.prototype.setCurrentDeckType=
function(){var d=q.getPageJson(),b=null;this.deckCatType&&"quest"!==this.deckCatType||(b=a.currentDeckType?a.currentDeckType:d.gameUser&&d.gameUser.deckType?d.gameUser.deckType:11);"support"==this.deckCatType&&(b=20);"arena"==this.deckCatType&&(b=21);"eventArena"==this.deckCatType&&(b=22);if("dungeon"===this.deckCatType||"dungeonInMap"===this.deckCatType)b=a.currentDungeonDeckType?a.currentDungeonDeckType:a.userEventDungeon&&a.userEventDungeon.selectedDeckType?a.userEventDungeon.selectedDeckType:
41;return b||11};n.prototype.deckPrmInit=function(){var d=q.getPageJson(),b=this.setCurrentDeckType(),c=a.storage.userDeckList.findWhere({deckType:b});c?d=this.deckDataCreate(c.toJSON()):(d={deckType:b,formationSheetId:111,formationSheet:_.findWhere(d.userFormationSheetList,{formationSheetId:111}).formationSheet,name:"Team"+String(b).slice(-1)},this.deckCatType&&"quest"!==this.deckCatType||(d.questPositionHelper=3),d=this.deckDataCreate(d));return{currentDeckType:b,currentDeckModel:d}};n.prototype.deckDataCreate=
function(d){var b=_.clone(d);b.deckCatType=this.deckCatType;if(!b.name&&!this.deckCatType||!b.name&&"quest"===this.deckCatType||!b.name&&"dungeon"===this.deckCatType||!b.name&&"dungeonInMap"===this.deckCatType){var c="Team"+String(d.deckType).slice(-1);b.name=c}var e={},f=[];_.each(b.formationSheet,function(a,b){if(-1!==b.indexOf("place")){f.push(b.split("place")[1]);a=a.split(",");var c=null;-1==a[0].indexOf("UP0")&&(c=[a[0].split("_")[0]],_.each(a,function(a){a=a.split(c[0]+"_")[1].toLowerCase();
a=a.split("_")[0]+"_"+a.split("_")[1];c.push(a)}));e[b]=c}});"support"==this.deckCatType?b.posArr="123456".split(""):("dungeon"!=this.deckCatType&&"dungeonInMap"!=this.deckCatType||Array.prototype.push.apply(f,["10","11"]),b.placeEffect=e,b.posArr=f);var k={};b.leaderPos=null;_.each(b.posArr,function(c,e){var h="userCardId"+(e+1);b[h]&&(h=b[h],h=_.findWhere(a.storage.userCardListEx.toJSON(),{id:h}),h.userCardId==b.questEpisodeUserCardId&&(b.leaderPos=Number(d["questPositionId"+(e+1)])),k["place"+
b["questPositionId"+(e+1)]]=h);"support"!==this.deckCatType&&b.questPositionHelper==c&&(h={},"quest"===this.deckCatType&&a.questSupportModel&&(h=a.questSupportModel),h.support=!0,k["place"+c]=h)}.bind(this));b.userCardObj=k;var m={};_.each(b.posArr,function(c,e){if(d["questPositionId"+(e+1)]){c="place"+d["questPositionId"+(e+1)];var h="userPieceId"+("00"+(e+1)).slice(-2),t=b.userCardObj[c],f=t?t.revision+1:0;for(e=0;4>e;){var g=h+(e+1);if(b[g]){0==c in m&&(m[c]=[]);var g=_.findWhere(a.storage.userPieceList.toJSON(),
{id:b[g]}),l=!1;0>=f&&(l="invalidRev");g.piece.charaList&&_.each(g.piece.charaList,function(a,b){a.charaId!==t.charaId&&(l="invalidChara")});"ALL"!==g.piece.attributeId&&g.piece.attributeId!==t.chara.attributeId&&(l="invalidAtt");f--;g.maxLevel=u.getMaxLevel(g.piece.rank,g.lbCount);g.invalidFlag=l;m[c][e]=g}else f--;e=e+1|0}}});if("quest"===this.deckCatType&&a.questSupportModel)for(c=0;4>c;){var g="equipPiece"+(c+1);if(a.questSupportModel[g]){var p="place"+d.questPositionHelper;0==p in m&&(m[p]=[]);
g=a.questSupportModel[g];g.maxLevel=u.getMaxLevel(g.piece.rank,g.lbCount);m[p][c]=g}c=c+1|0}b.userPieceObj=m;_.each(b.userCardObj,function(a,c){b.userPieceObj[c]&&(_.each(b.userPieceObj[c],function(b,c){b&&(a["equipPiece"+(c+1)]=b)}),a=x.totalEventEffectSet(a))});_.each(b.userCardObj,function(a,c){a.supportFlag||(a.addHp=a.hp?a.hp:0,a.addAttack=a.attack?a.attack:0,a.addDefense=a.defense?a.defense:0,a.memoriaHp=0,a.memoriaAttack=0,a.memoriaDefense=0,b.userPieceObj[c]&&_.each(b.userPieceObj[c],function(b){b&&
!b.invalidFlag&&(a.addHp+=b.hp,a.addAttack+=b.attack,a.addDefense+=b.defense,a.memoriaHp+=b.hp,a.memoriaAttack+=b.attack,a.memoriaDefense+=b.defense)}))});20==d.deckType&&(b.name="Support Team");21==d.deckType&&(b.name="Mirrors Team");22==d.deckType&&(b.name="Mirrors Event Team");return b};var y=function(a,b){switch(a){case "quest":return 11<=b&&19>=b;case "dungeon":case "dungeonInMap":return 41<=b&&49>=b;default:return 11<=b&&19>=b}},z={quest:"1",dungeon:"4",dungeonInMap:"4"};n.prototype.deckListDataCreate=
function(){var d=this.deckCatType||"quest",b=[];_.each(a.storage.userDeckList.toJSON(),function(a,c){if(y(this.deckCatType,a.deckType)){var d=[];_.each(a.formationSheet,function(a,b){-1!==b.indexOf("place")&&d.push(b.split("place")[1])});a.posArr=d;b.push(a)}}.bind(this));for(var c=0;9>c;){var e=z[d]+(c+1);_.findWhere(b,{deckType:Number(e)})||(e={name:"Team"+String(e).slice(-1),deckType:Number(e)},b.push(e));c=c+1|0}b.sort(function(a,b){return a.deckType<b.deckType?-1:a.deckType>b.deckType?1:0});
return b};n.prototype.nextPageFunc=function(a){"quest"===this.deckCatType&&this.questFunc(a);"dungeon"!==this.deckCatType&&"dungeonInMap"!==this.deckCatType||this.dungeonMapStartFunc(a)};n.prototype.questFunc=function(d){if(!this.questDisableFlg){a.androidKeyStop=!0;var b=function(){for(var a=[],b=0;10>b;){var c=d["userCardId"+(b+1)];c&&a.push(c);b=b+1|0}return a}();if(b.length)if((a.questBattleModel&&a.questBattleModel.questBattle.onlyCharaIds||a.questBattleModel&&a.questBattleModel.questBattle.containCharaIds)&&
!r.charaConditionCheck(a.questBattleModel.questBattle,b))b=r.charaConditionText(a.questBattleModel.questBattle),f.startSe(1002),k=new a.PopupClass({title:"Quest Conditions",popupId:"charaConditionPopup",content:b,decideBtnText:"OK",canClose:!1},null,function(){$("#charaConditionPopup .decideBtn").on(a.cgti,function(a){k.remove()})});else{var c={};c.questBattleId=a.questBattleModel.questBattle.questBattleId;c.deckType=d.deckType;"RAID"===a.questBattleModel.questType&&(c.raidId=a.questBattleModel.raidId);
_.each(d,function(a,b){-1!==b.indexOf("questPositionId")&&(c[b]=a);-1!==b.indexOf("userCardId")&&(c[b]=a);-1!==b.indexOf("userPieceId")&&(c[b]=a)});a.questSupportModel&&(a.questSupportModel.isNpc?c.npcHelpId=a.questSupportModel.npcHelpId:(c.helperUserId=a.questSupportModel.userId,a.questHelperId=a.questSupportModel.userId,c.helperUserCardId=a.questSupportModel.userCardId),c.helpAttributeId=a.questSupportModel.supportTabAtt.toUpperCase(),c.helperPositionId=d.questPositionHelper);var b=null,e=a.questBattleModel.questBattle.startStory,
l=[];a.questBattleModel.questBattle.questStory&&l.push(a.questBattleModel.questBattle.questStory);a.questBattleModel.questBattle.endStory&&l.push(a.questBattleModel.questBattle.endStory);a.questBattleModel.secret&&(b=a.questBattleModel.secret);this.questDisableFlg=!0;A(e,l,a.questBattleModel.userQuestAdventureList,c,b);f.startSe(1001)}else{f.startSe(1002);var k=new a.PopupClass({title:"Form Error",content:"Enter 1 or more characters.",closeBtnText:"OK"});a.androidKeyStop=!1}}};var A=function(d,b,
c,e,l){$(a.ready.target).on("webkitAnimationEnd",function(){f.changeBg("web_black.jpg");$(a.ready.target).off();$(a.ready.target).on("webkitAnimationEnd",function(b){"readyFadeOut"==b.originalEvent.animationName&&(a.ready.target.className="")});var k=!0,m=!0,g=0;if(!a.questBattleModel.storyForceStart){_.each(c,function(a){d===a.adventureId&&(k=!1);-1<b.indexOf(a.adventureId)&&g++});if(0==b.length||0<b.length&&b.length==g)m=!1;"MAIN"!=a.questBattleModel.questType&&"SUB"!=a.questBattleModel.questType&&
"CHARA"!=a.questBattleModel.questType&&"COSTUME"!=a.questBattleModel.questType||a.storage.gameUser.toJSON().skipAdventure||(m=k=!0);d||(k=!1)}a.questBattleModel.eventBranchData&&!a.questBattleModel.eventBranchData.startStoryJson&&(k=!1);f.endL2d();var p=null;if(window.isBrowser)a.stubQuest=e,f.sendCommand("QuestStub");else if(k){var h=function(b){$("#commandDiv").on("nativeCallback",function(c,e){$("#commandDiv").off();e&&e.isSkipped&&(c={},c.adventureId=String(d),q.ajaxPost(a.linkList.adventureSkip,
c,function(b){a.responseSetStorage(b)}));a.questBattleModel.eventBranchData&&e&&e.alternativeIdList&&q.ajaxPost(a.linkList.branchAlternativeStart,{pointId:a.questBattleModel.eventBranchData.pointId,alternativeIdList:e.alternativeIdList});$("#commandDiv").on("nativeCallback",function(a,b){$("#commandDiv").off();v(b);location.href="#/QuestBackground"});w(b)})},n=function(b,c){$("#commandDiv").on("nativeCallback",function(){$("#commandDiv").off();h(c);f.startStory(b);window.isBrowser&&$("#commandDiv").trigger("nativeCallback")});
f.downloadFileFullVoice("section_"+a.questBattleModel.questBattle.sectionId);window.isBrowser&&$("#commandDiv").trigger("nativeCallback")},r=function(b,c){$("#commandDiv").on("nativeCallback",function(){$("#commandDiv").off();h(c);f.startStory(b);window.isBrowser&&$("#commandDiv").trigger("nativeCallback")});f.downloadFileFullVoice("section_event_"+a.questBattleModel.eventObj.event.eventId);window.isBrowser&&$("#commandDiv").trigger("nativeCallback")},p=function(b){var c=String(d);l&&(c+="_"+l);setTimeout(function(){f.setWebView(!1);
a.questBattleModel.eventBranchData?(h(b),f.startBranchStory(a.questBattleModel.eventBranchData.startStoryJson)):"MAIN"==a.questBattleModel.questType?n(c,b):a.questBattleModel.eventObj&&a.questBattleModel.eventObj.event&&a.questBattleModel.eventObj.event.existsVoice?r(c,b):(h(b),f.startStory(c),window.isBrowser&&$("#commandDiv").trigger("nativeCallback"))},500)};$("#popupArea").on(a.cgti,"#resultCodeError .popupCloseBtn",function(b){b.preventDefault();a.isScrolled()||($("#popupArea").off(),f.nativeReload("#/TopPage"))});
q.ajaxPost(a.linkList.questStart,e,p)}else h=function(a){$("#commandDiv").on("nativeCallback",function(a,b){$("#commandDiv").off();v(b);location.href="#/QuestBackground"});w(a)},p=function(b){setTimeout(function(){f.setWebView(!1);if(m){var c=null;"MAIN"==a.questBattleModel.questType?c="section_"+a.questBattleModel.questBattle.sectionId:a.questBattleModel.eventObj&&a.questBattleModel.eventObj.event&&a.questBattleModel.eventObj.event.existsVoice&&(c="section_event_"+a.questBattleModel.eventObj.event.eventId);
c?($("#commandDiv").on("nativeCallback",function(){$("#commandDiv").off();h(b)}),f.downloadFileFullVoice(c),window.isBrowser&&$("#commandDiv").trigger("nativeCallback")):h(b)}else h(b)},500)},$("#popupArea").on(a.cgti,"#resultCodeError .popupCloseBtn",function(b){b.preventDefault();a.isScrolled()||($("#popupArea").off(),f.nativeReload("#/TopPage"))}),"RAID"!==a.questBattleModel.questType?q.ajaxPost(a.linkList.questStart,e,p):q.ajaxPost(a.linkList.raidQuestStart,e,p)});a.addClass(a.ready.target,"preNativeFadeIn")},
w=function(d){a.acpTimeCure&&(clearInterval(a.acpTimeCure),a.acpTimeCure=null);var b=null;if(d.userQuestBattleResultList[0]&&d.userQuestBattleResultList[0].questBattle&&d.userQuestBattleResultList[0].questBattle.sectionId){var b=d.userQuestBattleResultList[0].questBattleId,c={},e=a.storage.userSectionList.findWhere({sectionId:d.userQuestBattleResultList[0].questBattle.sectionId});if(a.searchQuestGiftId&&"MAIN"==e.toJSON().section.questType||a.searchQuestGiftId&&"SUB"==e.toJSON().section.questType||
a.searchQuestGiftId&&"CHARA"==e.toJSON().section.questType||a.searchQuestGiftId&&"COSTUME"==e.toJSON().section.questType)c.resultUrl="/magica/index.html#/QuestResult",c.retireUrl="/magica/index.html#/SearchQuest/"+b;else switch(e.toJSON().section.questType){case "SUB":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/SubQuest";break;case "CHARA":case "COSTUME":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/CharaQuest";break;case "EVENT_S":c.resultUrl=
"/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventTrainingTop";break;case "COMPOSE":case "MATERIAL":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventQuest";break;case "TOWER":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventTowerTop";break;case "DAILYTOWER":e=e.toJSON().section.parameter.split("\x3d")[1];c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventDailyTowerTop"+("NORMAL"==
e?"/normal/"+b:"CHALLENGE"==e?"/challenge/"+b:"/exchallenge/"+b);break;case "BRANCH":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventBranchTop";break;case "SINGLERAID":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventSingleRaidTop/"+b;break;case "STORYRAID":c.resultUrl="/magica/index.html#/QuestResult";c.retireUrl="/magica/index.html#/EventStoryRaidTop/"+b;break;case "RAID":c.resultUrl="/magica/index.html#/EventRaidTop";c.retireUrl=
"/magica/index.html#/EventRaidTop";break;default:c.resultUrl="/magica/index.html#/QuestResult",c.retireUrl="/magica/index.html#/MainQuest"}b=c}f.setWebView(!1);f.startQuest(d.userQuestBattleResultList[0].id,b);window.isBrowser&&$("#commandDiv").trigger("nativeCallback")};n.prototype.dungeonMapStartFunc=function(d){if(!this.questDisableFlg)if(a.androidKeyStop=!0,function(){for(var a=[],b=0;10>b;){var f=d["userCardId"+(b+1)];f&&a.push(f);b=b+1|0}return a}(),d.leaderPos){if("dungeon"===this.deckCatType){f.startSe(1001);
var b={areaId:a.dungeonAreaModel.areaId,deckType:d.deckType};this.questDisableFlg=!0;q.ajaxPost(a.linkList.dungeonStart,b,function(b){a.responseSetStorage(b);location.href="#/EventDungeonMap"})}"dungeonInMap"===this.deckCatType&&(f.startSe(1002),a.backLinkHandler())}else f.startSe(1002),new a.PopupClass({title:"Form Error",content:"Please set at least one Main Magical Girl.",closeBtnText:"OK"}),a.androidKeyStop=!1};return n});