define("underscore backbone backboneCommon ajaxControl command text!template/formation/DeckFormation.html text!css/formation/DeckFormation.css cardUtil memoriaUtil js/view/chara/CharaListView js/card/CardPopup js/memoria/MemoriaPopup QuestUtil DeckUtil".split(" "),function(f,A,a,D,q,O,P,Q,V,R,E,F,W,S){var H=A.Model.extend(),G=null,g=null,y=null,l=null,d=null,C,v,T=A.View.extend({initialize:function(a){this.template=f.template(O);this.createDom()},render:function(){var a=D.getPageJson();a.deckCatType=
g;this.$el.html(this.template(a));return this},createDom:function(){var b={hideStatus:!0};if("quest"===g||"dungeon"===g||"dungeonInMap"===g)b.hideMenu=!0;a.setGlobalView(b);a.content.append(this.render().el);this.createView()},createView:function(){I.prototype.parentView=this;I.prototype.template=f.template($("#DeckViewTemp").text());var b=a.doc.createDocumentFragment();d=new I({model:new H(l)});b.appendChild(d.render().el);a.doc.querySelector("#DeckFormation").appendChild(b);a.doc.querySelector(".memoriaEquipMode")&&
a.addClass(a.doc.querySelector("#pieceEquipBtn"),"on");a.questBattleModel&&(a.addClass(a.doc.querySelector(".attBox"),"enemyDetail"),f.each(a.questBattleModel.questBattle.waveEnemyAttributeIdList,function(b){b=b.toLowerCase();a.addClass(a.doc.querySelector(".enemyDetail ."+b),"on")}));q.getBaseData(a.getNativeObj());z(d.model.toJSON(),l);J.prototype.parentView=this;J.prototype.template=f.template($("#UserFormationListTemp").text());b=a.doc.createDocumentFragment();a.storage.userFormationSheetList.comparator=
function(a){return a.get("formationSheetId")};a.storage.userFormationSheetList.sort();a.storage.userFormationSheetList.each(function(a){var c=a.toJSON(),h=[];f.each(c.formationSheet,function(a,b){-1!==b.indexOf("place")&&h.push(b.split("place")[1])});a.set({posArr:h});a=new J({model:a});b.appendChild(a.render().el)});a.doc.querySelector(".formationSheetListInner").appendChild(b);K.prototype.parentView=this;K.prototype.template=f.template($("#deckChangeModeTemp").text());var c=w.deckListDataCreate(),
b=a.doc.createDocumentFragment();this.deckChangeModeView=new K({model:new H(c)});b.appendChild(this.deckChangeModeView.render().el);a.doc.querySelector("#deckSelectWrap").appendChild(b);a.ready.hide()},events:function(){var b={};b[a.cgti+" #mainBtn"]=this.deckSave;b[a.cgti+" #nextPageBtn"]=this.nextPageFunc;b[a.cgti+" #pieceEquipBtn"]=this.pieceEquipMode;b[a.cgti+" #formationSheetChangeBtn"]=this.formationSheetChange;b[a.cgti+" #dispModeChangeBtn"]=this.dispModeChange;b[a.cgti+" #previewBtn"]=this.deckPreview;
b[a.cgti+" #deckRemovePopBtn"]=this.deckRemovePop;b[a.cgti+" #previewCloseBtn"]=this.deckPreviewClose;b[a.cgti+" #formationSheetDecideBtn"]=this.formationSheetClose;b[a.cgti+" #deckCancelBtn"]=this.modeCancel;b[a.cgti+" #deckCopyModeBtn"]=this.deckCopyMode;return b},deckSave:function(b){if(b&&(b.preventDefault(),a.isScrolled()||b.currentTarget.classList.contains("off")))return;var c=this;if(a.tutorialId)if(a.doc.getElementById("baseContainer").classList.contains("type03_2"))a.tutorialUtil[a.tutorialId]("save2");
else a.tutorialUtil[a.tutorialId]("save");b=d.model.toJSON();for(var e={deckType:b.deckType,formationSheetId:b.formationSheetId,name:b.name,questPositionHelper:b.questPositionHelper,episodeUserCardId:b.questEpisodeUserCardId},n=[],h=[],m=[],k=0;10>k;){if(b["userCardId"+(k+1)]){n.push(b["userCardId"+(k+1)]);h.push(b["questPositionId"+(k+1)]);for(var t="place"+b["questPositionId"+(k+1)],r=[],p=0;4>p;){if(b.userPieceObj[t]&&b.userPieceObj[t][p]&&!b.userPieceObj[t][p].invalidFlag){var u="userPieceId"+
("000"+(k+1)+(p+1)).slice(-3);b[u]&&r.push(b[u])}p=p+1|0}m.push(r)}k=k+1|0}"arena"===g&&!n.length||"support"===g&&!n.length?(q.startSe(1002),new a.PopupClass({title:"Form Error",content:"Enter 1 or more characters.",closeBtnText:"OK"}),a.androidKeyStop=!1):"dungeon"===g&&!b.leaderPos||"dungeonInMap"===g&&!b.leaderPos?(q.startSe(1002),new a.PopupClass({title:"Form Error",content:"Enter 1 or more characters.",closeBtnText:"OK"}),a.androidKeyStop=!1):(e.userCardIds=n,e.questPositionIds=h,e.userPieceIdLists=
m,q.startSe(1002),D.ajaxPost(a.linkList.userDeckSave,e,function(b){a.responseSetStorage(b);q.getBaseData(a.getNativeObj());a.holdDeck=null;var h=w.deckListDataCreate();c.deckChangeModeView.model.clear({silent:!0});c.deckChangeModeView.model.set(h);b.userDeckList?(b=b.userDeckList[0],b.formationSheet||(b.formationSheet=f.findWhere(C.userFormationSheetList,{formationSheetId:b.formationSheetId}).formationSheet,a.storage.userDeckList.findWhere({deckType:b.deckType}).set({formationSheet:b.formationSheet}))):
b=d.model.toJSON();l=w.deckDataCreate(b);d.model.clear({silent:!0});d.model.set(w.deckDataCreate(l));z(d.model.toJSON(),l)}))},nextPageFunc:function(b){b.preventDefault();a.isScrolled()||w.nextPageFunc(d.model.toJSON())},pieceEquipMode:function(b){if(b&&(b.preventDefault(),a.isScrolled()))return;a.doc.querySelector(".deckViewWrap").classList.contains("memoriaEquipMode")?(a.removeClass(a.doc.querySelector(".deckViewWrap"),"memoriaEquipMode"),a.removeClass(a.doc.querySelector("#pieceEquipBtn"),"on")):
(a.addClass(a.doc.querySelector(".deckViewWrap"),"memoriaEquipMode"),a.addClass(a.doc.querySelector("#pieceEquipBtn"),"on"))},formationSheetChange:function(b){b.preventDefault();a.isScrolled()||(d.selectModel=null,d.selectPos=null,a.removeClass(a.doc.querySelector("#charaListWrap"),"open"),setTimeout(function(){a.addClass(a.doc.querySelector("#DeckFormation"),"formation");var b=a.doc.querySelectorAll('[data-fsid\x3d"'+d.model.toJSON().formationSheetId+'"]')[0];a.addClass(b,"select");a.addClass(a.doc.querySelector("#deckFooter .default"),
"noneDisp");a.removeClass(a.doc.querySelector("#deckFooter .fs"),"noneDisp");a.addClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");a.removeClass(a.doc.querySelector("#sideMenu"),"anim");a.addClass(a.doc.querySelector("#menu"),"noneDisp");a.scrollSet("formationSheetListOuter","formationSheetListInner");a.scrollRefresh(null,null,!0)},0))},dispModeChange:function(b){b.preventDefault();a.isScrolled()||(b=a.doc.querySelector(".deckViewWrap"),b.classList.contains("memoriaEquipMode")?(a.removeClass(b,
"memoriaEquipMode"),a.removeClass(a.doc.querySelector("#pieceEquipBtn"),"on")):b.classList.contains("charaStatusMode")?(a.removeClass(b,"charaStatusMode"),a.addClass(b,"diskMode")):b.classList.contains("diskMode")?(a.removeClass(b,"diskMode"),a.addClass(b,"skillMode")):b.classList.contains("skillMode")&&(a.removeClass(b,"skillMode"),a.addClass(b,"charaStatusMode")))},deckPreview:function(b){b.preventDefault();if(!a.isScrolled()){setTimeout(function(){a.addClass(a.doc.querySelector("#DeckFormation"),
"preview");a.addClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.removeClass(a.doc.querySelector("#deckFooter .preview"),"noneDisp");a.addClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");a.removeClass(a.doc.querySelector("#sideMenu"),"anim");a.addClass(a.doc.querySelector("#menu"),"noneDisp")},0);var c=[],e={1:8,2:5,3:2,4:7,5:4,6:1,7:6,8:3,9:0};f.each(d.model.toJSON().userCardObj,function(a,b){if(a.card){var h=d.model.toJSON().questEpisodeUserCardId==a.id?!0:!1,n={};n.miniCharId=
a.card.miniCharaNo;n.positionId=e[b.split("place")[1]];n.isLeader=h;n.isSupport=a.support;a.faceHidden&&(n.isUnknown=!0);10>e[b.split("place")[1]]&&c.push(n)}});setTimeout(function(){q.formationPreview(c)},100)}},deckRemovePop:function(b){b.preventDefault();if(!a.isScrolled()){a.removeClass(a.doc.querySelector(".deckViewWrap"),"memoriaEquipMode");b=$("#TeamRemovePop").text();var c=d.model.toJSON();c.popupType="typeC";var e=new a.PopupClass(c,b,function(){$("#popupArea .decideBtn").on(a.cgti,function(b){b=
d.model.toJSON();b=w.deckDataCreate({deckType:b.deckType,formationSheet:b.formationSheet,formationSheetId:b.formationSheetId,questPositionHelper:b.questPositionHelper,name:b.name});d.model.clear({silent:!0});d.model.set(b);z(b,l);q.getBaseData(a.getNativeObj());e.remove()})})}},deckPreviewClose:function(b){b.preventDefault();a.isScrolled()||(setTimeout(function(){a.removeClass(a.doc.querySelector("#DeckFormation"),"preview");a.removeClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.addClass(a.doc.querySelector("#deckFooter .preview"),
"noneDisp");a.removeClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");"quest"!==g&&a.removeClass(a.doc.querySelector("#menu"),"noneDisp")},0),setTimeout(function(){q.formationPreviewRemove()},20))},formationSheetClose:function(b){b.preventDefault();a.isScrolled()||setTimeout(function(){a.removeClass(a.doc.querySelector("#DeckFormation"),"formation");var b=a.doc.querySelectorAll('[data-fsid\x3d"'+d.model.toJSON().formationSheetId+'"]')[0];a.removeClass(b,"select");a.removeClass(a.doc.querySelector("#deckFooter .default"),
"noneDisp");a.addClass(a.doc.querySelector("#deckFooter .fs"),"noneDisp");a.removeClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");"quest"!==g&&a.removeClass(a.doc.querySelector("#menu"),"noneDisp")},0)},modeCancel:function(b){b.preventDefault();a.isScrolled()||setTimeout(function(){a.removeClass(a.doc.querySelector("#DeckFormation"),"deckChange");a.removeClass(a.doc.querySelector("#DeckFormation"),"deckCopy");a.removeClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.removeClass(a.doc.querySelector("#globalBackBtn"),
"noneDisp");"quest"!==g&&a.removeClass(a.doc.querySelector("#menu"),"noneDisp");d.copyMode=!1},0)},deckCopyMode:function(b){b.preventDefault();a.isScrolled()||d.deckCopyMode(b)}}),J=A.View.extend({initialize:function(a){this.listenTo(this.parentView,"removeView",this.removeView)},className:"list se_decide commonFrame4 flexBox",events:function(){var b={};b[a.cgti]=this.previewSet;return b},render:function(){this.$el.html(this.template({model:this.model.toJSON()}));this.el.dataset.fsid=this.model.toJSON().formationSheetId;
return this},previewSet:function(b){b.preventDefault();if(!a.isScrolled()){a.removeClass(a.doc.querySelector(".list.select"),"select");a.addClass(this.el,"select");b=this.model.toJSON().formationSheetId;var c=f.clone(d.model.toJSON());c.formationSheetId=b;c.formationSheet=a.storage.userFormationSheetList.findWhere({formationSheetId:b}).toJSON().formationSheet;var e=[];f.each(c.formationSheet,function(a,b){-1!==b.indexOf("place")&&e.push(b.split("place")[1])});"dungeon"!==g&&"dungeonInMap"!==g||Array.prototype.push.apply(e,
["10","11"]);f.each(c,function(a,b){-1!==b.indexOf("questPosition")&&(a=c.posArr.indexOf(String(a)),c[b]=Number(e[a]))});c.posArr=e;b=w.deckDataCreate(c);d.model.set(b);z(d.model.toJSON(),l)}},removeView:function(){this.off();this.remove()}}),K=A.View.extend({className:"deckSelectInner",events:function(){var b={};b[a.cgti+" .deckSelectDetail"]=this.deckSelect;return b},initialize:function(a){this.listenTo(this.model,"change",this.render);this.listenTo(this.parentView,"removeView",this.removeView)},
render:function(){f.each(this.model.toJSON(),function(b,c){c=f.findWhere(a.storage.userCardListEx.toJSON(),{userCardId:b.questEpisodeUserCardId});b.userCardId1&&(b.leaderCardModel=c||null)});this.$el.html(this.template({model:this.model.toJSON(),img:a.imgData}));return this},deckSelect:function(b){b.preventDefault();a.isScrolled()||(d.copyMode?(this.deckCopyRun(b.currentTarget.dataset.decktype),d.copyMode=!1):this.deckViewCreate(b.currentTarget.dataset.decktype))},deckViewCreate:function(b){b=Number(b);
var c={deckType:b,formationSheetId:111,formationSheet:f.findWhere(C.userFormationSheetList,{formationSheetId:111}).formationSheet,name:"Team"+String(b).slice(-1)};g&&"quest"!==g||(c.questPositionHelper=3);b=a.storage.userDeckList.findWhere({deckType:b})?a.storage.userDeckList.findWhere({deckType:b}).toJSON():c;l=b=w.deckDataCreate(b);y=l.deckType;d.model.clear({silent:!0});d.model.set(b);d.bonusTextUpdate();z(d.model.toJSON(),l);q.getBaseData(a.getNativeObj());setTimeout(function(){a.removeClass(a.doc.querySelector("#DeckFormation"),
"deckChange");a.removeClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.removeClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");"quest"!==g&&a.removeClass(a.doc.querySelector("#menu"),"noneDisp")},0)},deckCopyRun:function(b){b=Number(b);var c={deckType:y,formationSheetId:111,formationSheet:f.findWhere(C.userFormationSheetList,{formationSheetId:111}).formationSheet,name:"Team"+String(y).slice(-1)};g&&"quest"!==g||(c.questPositionHelper=3);var e=a.storage.userDeckList.findWhere({deckType:b})?
a.storage.userDeckList.findWhere({deckType:b}).toJSON():c;b=w.deckDataCreate(e);b.deckType=y;b.name=l.name;d.model.clear({silent:!0});d.model.set(b);d.bonusTextUpdate();z(d.model.toJSON(),l);q.getBaseData(a.getNativeObj());setTimeout(function(){new a.PopupClass({title:"Copy",content:"\x3cspan class\x3d'c_pink'\x3e"+e.name+"\x3c/span\x3e has been copied to \x3cspan class\x3d'c_pink'\x3e"+l.name+"\x3c/span\x3e.\x3cbr\x3e\x3cbr\x3e\x3cspan class\x3d'c_red'\x3eTap the OK Button on the next page\x3cbr\x3eto save changes.\x3c/span\x3e",
closeBtnText:"OK",popupType:"typeC"});a.removeClass(a.doc.querySelector("#DeckFormation"),"deckCopy");a.removeClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.removeClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");"quest"!==g&&a.removeClass(a.doc.querySelector("#menu"),"noneDisp")},0)},removeView:function(){this.off();this.remove()}}),I=A.View.extend({className:function(){var b="deckViewWrap";return b=a.holdDeck&&a.holdDeck.deckType==y?b+" memoriaEquipMode charaStatusMode":b+
" charaStatusMode"},initialize:function(b){this.selectPos=this.selectModel=null;b=a.holdDeck&&a.holdDeck.deckType==y?a.holdDeck:this.model.toJSON();b=w.deckDataCreate(b);this.model.clear({silent:!0});this.model.set(b);this.listenTo(this.model,"change",this.changeRender);this.listenTo(this.parentView,"removeView",this.removeView)},events:function(){var b={};b[a.cgti+" .deckParts"]=this.deckSet;b[a.cgti+" .epSetBtn"]=this.leaderSet;b[a.cgti+" .deckName"]=this.nameChange;b[a.cgti+" .deckChangeArrow"]=
this.deckChange;b[a.cgti+" .deckChangeModeBtn"]=this.deckChangeMode;b[a.cgti+" .autoFormationPopBtn"]=this.autoFormationPop;b[a.cgti+" .memoriaWrap span"]=this.pieceEquip;b[a.cgti+" .memoriaWrap .memoriaSetEquipBtn"]=this.memoriaSetEquipLink;b["touchstart .tapArea"]=this.popupTimeStart;b["touchstart .memoriaSkillWrap"]=this.popupTimeStart;b["touchstart .memoriaWrap .equiped"]=this.memoriaPopupTimeStart;return b},render:function(){this.$el.html(this.template({model:this.model.toJSON(),deckCatType:g,
img:a.imgData}));return this},changeRender:function(){this.$el.html(this.template({model:this.model.toJSON(),deckCatType:g,img:a.imgData}));return this},deckSet:function(b,c){if(!a.doc.querySelector(".deckViewWrap").classList.contains("memoriaEquipMode")&&!a.detailView){var e=null;if(b){b.preventDefault();if(a.isScrolled())return;e=b.currentTarget.dataset.posindex;q.startSe(1002)}var d={1:"ALL",2:"FIRE",3:"WATER",4:"TIMBER",5:"LIGHT",6:"DARK"};E.popupTimerStop();var h=f.clone(this.model.toJSON()),
m=f.clone(h.userCardObj),k=f.clone(h.userPieceObj),t=e?m["place"+e]:f.clone(c.model.toJSON());if(this.selectModel||this.selectPos){if(e)m["place"+e]=this.selectModel,m["place"+this.selectPos]=t||null,c=b=null,k["place"+e]&&(b=f.clone(k["place"+e])),k["place"+this.selectPos]&&(c=f.clone(k["place"+this.selectPos])),c?k["place"+e]=c:delete k["place"+e],b?k["place"+this.selectPos]=b:delete k["place"+this.selectPos];else if(this.selectModel&&t.userCardId==this.selectModel.userCardId)m["place"+this.selectPos]=
null;else{var r=null;f.each(m,function(a,b){var c=!1;a&&a.userCardId==t.userCardId&&(c=!0);c&&(m[b]=null,r=b)});m["place"+this.selectPos]=t;e=null;k[r]&&(e=f.clone(k[r]));e&&(k["place"+this.selectPos]=e)}for(e=0;10>e;)delete h["userCardId"+(e+1)],delete h["questPositionId"+(e+1)],e=e+1|0;for(e=0;10>e;){var p="userPieceId"+("00"+(e+1)).slice(-2);for(b=0;4>b;)delete h[p+(b+1)],b=b+1|0;e=e+1|0}e=[];for(p in m)e.push(p);e.sort(function(a,b){return Number(a.split("place")[1])<Number(b.split("place")[1])?
-1:Number(a.split("place")[1])>Number(b.split("place")[1])?1:0});var u=1;f.each(e,function(a,b){b=a.split("place")[1];if(m[a]&&m[a].support&&20!==h.deckType)h.questPositionHelper=Number(b);else if(m[a]&&!m[a].supportFlag){var c="questPositionId"+u,e="userCardId"+u,d="userPieceId"+("00"+u).slice(-2);h[c]=Number(b);h[e]=m[a].userCardId;f.each(k[a],function(a,b){a&&a.id&&(h[d+(b+1)]=a.id)});u++}});h.userCardObj=m;h.userPieceObj=k;20!==h.deckType&&(h=N(h));h=w.deckDataCreate(h);this.model.clear({silent:!0});
this.model.set(h);z(this.model.toJSON(),l);q.getBaseData(a.getNativeObj());this.selectModel=this.selectPos=null;a.removeClass(a.doc.querySelector(".deckParts.select"),"select");"support"===g?(a.doc.querySelector("#charaListWrap").className="",a.removeClass(a.doc.querySelector(".deckPartsWrap"),"tapBlock")):a.removeClass(a.doc.querySelector("#charaListWrap"),"open")}else{if(a.tutorialId)a.tutorialUtil[a.tutorialId]("set");a.removeClass(a.doc.querySelector(".deckParts.select"),"select");a.removeClass(a.doc.querySelector("#charaListWrap"),
"open");this.selectPos=e;this.selectModel=f.clone(t);a.addClass(b.currentTarget,"select");if(this.selectModel&&!this.selectModel.support||!this.selectModel)v.charaListView.cardSort.multiSort(),U(),20==this.model.toJSON().deckType&&(a.addClass(a.doc.querySelector("#charaListWrap"),d[e]),a.addClass(a.doc.querySelector(".deckPartsWrap"),"tapBlock")),a.addClass(a.doc.querySelector("#charaListWrap"),"open"),a.scrollRefresh(null,null,!0,null)}}},leaderSet:function(b){b.preventDefault();if(!a.isScrolled()&&
(b.stopPropagation(),E.popupTimerStop(),F.popupTimerStop(),b=b.currentTarget,!b.classList.contains("on"))){q.startSe(1008);var c=f.clone(this.model.toJSON());c.questEpisodeUserCardId=c.userCardObj["place"+Number(b.parentNode.dataset.posindex)].userCardId;c=N(c);c=w.deckDataCreate(c);this.model.set(c);z(this.model.toJSON(),l);q.getBaseData(a.getNativeObj());this.selectModel=this.selectPos=null;a.removeClass(a.doc.querySelector(".deckParts.select"),"select");a.removeClass(a.doc.querySelector("#charaListWrap"),
"open")}},nameChange:function(b){b.preventDefault();if(!a.isScrolled()&&!a.doc.querySelector(".deckParts.select")){var c=this;b=$("#DeckNameChangeTemp").text();var e=d.model.toJSON();e.popupType="typeC";var f=new a.PopupClass(e,b,function(){a.nativeKeyBoard("commentInput",10,null,"textCount");a.doc.getElementById("commentDecide").addEventListener(a.cgti,function(b){b.preventDefault();a.isScrolled()||(a.tapBlock(!0),c.model.set({name:a.doc.getElementById("commentInput").value}),z(c.model.toJSON(),
l),q.getBaseData(a.getNativeObj()),f.remove(),a.tapBlock(!1))})})}},deckChange:function(b){b.preventDefault();if(!a.isScrolled()&&!a.doc.querySelector(".deckViewWrap").classList.contains("deckChangeBg")){this.selectModel=this.selectPos=null;a.removeClass(a.doc.querySelector(".deckParts.select"),"select");a.removeClass(a.doc.querySelector("#charaListWrap"),"open");var c=l.deckType;b=b.currentTarget.classList.contains("arrowR")?1:-1;var c=c+b,e={quest:"1",dungeon:"4"};b=Number(e[g||"quest"]+"9");e=
Number(e[g||"quest"]+"1");c=c>b?e:c;c=c<e?b:c;b={deckType:c,formationSheetId:111,formationSheet:f.findWhere(C.userFormationSheetList,{formationSheetId:111}).formationSheet,name:"Team"+String(c).slice(-1)};g&&"quest"!==g||(b.questPositionHelper=3);b=a.storage.userDeckList.findWhere({deckType:c})?a.storage.userDeckList.findWhere({deckType:c}).toJSON():b;l=b=w.deckDataCreate(b);y=c;this.model.clear({silent:!0});this.model.set(b);d.bonusTextUpdate();a.removeClass(a.doc.querySelector(".deckViewWrap"),
"memoriaEquipMode");a.removeClass(a.doc.querySelector("#pieceEquipBtn"),"on");q.getBaseData(a.getNativeObj())}},deckChangeMode:function(b){b.preventDefault();a.isScrolled()||a.doc.querySelector(".deckViewWrap").classList.contains("deckChangeBg")||(this.selectModel=this.selectPos=null,a.removeClass(a.doc.querySelector(".deckParts.select"),"select"),a.removeClass(a.doc.querySelector("#charaListWrap"),"open"),setTimeout(function(){a.addClass(a.doc.querySelector("#DeckFormation"),"deckChange");a.addClass(a.doc.querySelector("#deckFooter .default"),
"noneDisp");a.addClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");a.addClass(a.doc.querySelector("#menu"),"noneDisp")},0))},deckCopyMode:function(b){this.copyMode=!0;this.selectModel=this.selectPos=null;a.removeClass(a.doc.querySelector(".deckParts.select"),"select");a.removeClass(a.doc.querySelector("#charaListWrap"),"open");(b=a.doc.getElementById("deckSelectWrap").getElementsByClassName("currentDeck")[0])&&a.removeClass(b,"currentDeck");b=a.doc.getElementById("deckSelectWrap").getElementsByClassName("deck"+
l.deckType)[0];a.addClass(b,"currentDeck");setTimeout(function(){a.addClass(a.doc.querySelector("#DeckFormation"),"deckCopy");a.addClass(a.doc.querySelector("#deckFooter .default"),"noneDisp");a.addClass(a.doc.querySelector("#globalBackBtn"),"noneDisp");a.addClass(a.doc.querySelector("#menu"),"noneDisp")},0)},autoFormationPop:function(b){b.preventDefault();if(!a.isScrolled()){var c=function(){switch(g){case "support":return 6;case "arena":return 5;case "dungeon":return 7;default:return 4}},e={FIRE:!1,
WATER:!1,TIMBER:!1,LIGHT:!1,DARK:!1,VOID:!1},n=["ABILITY","SKILL","ABILITY","SKILL"];b="support"!=g?$("#autoFormationTemp").text():$("#autoFormationSupportTemp").text();new a.PopupClass({exClass:"autoFormationPop"},b,function(){$("#autoFilterAtt").on(a.cgti,function(b){b.preventDefault();if(!a.isScrolled()&&!b.currentTarget.classList.contains("on")){a.addClass(b.currentTarget,"on");b=a.doc.getElementById("autoFormationAttWrap").getElementsByClassName("attribute");for(var c=0;c<b.length;c++)a.removeClass(b[c],
"on")}});$("#autoFormationAttWrap .attribute").on(a.cgti,function(b){b.preventDefault();a.isScrolled()||(b.currentTarget.classList.contains("on")?a.removeClass(b.currentTarget,"on"):(a.removeClass(a.doc.getElementsByClassName("filterAtt")[0],"on"),a.addClass(b.currentTarget,"on")))});$("#autoFormationStatusWrap .status").on(a.cgti,function(b){b.preventDefault();a.isScrolled()||(a.removeClass(a.doc.querySelector("#autoFormationStatusWrap .on"),"on"),a.addClass(b.currentTarget,"on"))});$("#autoFormationBtn").on(a.cgti,
function(b){b.preventDefault();if(!a.isScrolled()){if("support"!==g){var h=0;a.doc.getElementById("autoFilterAtt").classList.contains("on")?(e={FIRE:!0,WATER:!0,TIMBER:!0,LIGHT:!0,DARK:!0,VOID:!0},h=6):(b=a.doc.querySelectorAll(".autoFormationPop .attribute.on"),f.each(b,function(a){e[a.dataset.typeFilter]=!0;h++}));if(0===h){new a.PopupClass({title:"Auto",content:"You must select at least one Element.",closeBtnText:"OK",popupType:"typeC"});return}}else e={FIRE:!0,WATER:!0,TIMBER:!0,LIGHT:!0,DARK:!0,
VOID:!0};var k=f.filter(a.storage.userCardListEx.toJSON(),function(a){return e[a.chara.attributeId]}),t=a.doc.querySelector(".autoFormationPop .filterWrap .on").dataset.statusSort;k.sort(function(a,b){return a[t]<b[t]?1:a[t]>b[t]?-1:0});if("support"==g){b=[];var r={ALL:null,FIRE:null,WATER:null,TIMBER:null,LIGHT:null,DARK:null};f.each(k,function(a,b){b=a.chara.attributeId;r.ALL?"VOID"===b||r[b]||(r[b]=a):r.ALL=a});b[0]=r.ALL;b[1]=r.FIRE;b[2]=r.WATER;b[3]=r.TIMBER;b[4]=r.LIGHT;b[5]=r.DARK;k=b}else if(0===
k.length){new a.PopupClass({title:"Auto",content:"You do not have a Magical Girl of the selected Element.",closeBtnText:"OK",popupType:"typeC"});return}k.length=c();var p=d.model.toJSON(),u={deckType:p.deckType,formationSheet:p.formationSheet,formationSheetId:p.formationSheetId,name:p.name,userCardObj:{}};p.questPositionHelper&&(u.questPositionHelper=p.questPositionHelper);b=a.storage.userPieceList.toJSON();var L=[],M=[],L=f.filter(b,function(a){return"SKILL"===a.piece.pieceType}),M=f.filter(b,function(a){return"ABILITY"===
a.piece.pieceType});L.sort(function(a,b){a=a.hp+a.defense;b=b.hp+b.defense;return a<b?1:a>b?-1:0});M.sort(function(a,b){a=a.hp+a.attack;b=b.hp+b.attack;return a<b?1:a>b?-1:0});var v={SKILL:L,ABILITY:M},y={},C={SKILL:0,ABILITY:0},A=0,x=1;f.each(p.posArr,function(a,b){b=Number(a);if(p.questPositionHelper!==b){var c="userCardId"+x,e="questPositionId"+x;k[A]&&(u.userCardObj["place"+a]=k[A],u[c]=k[A].userCardId,u[e]=b,x++);A++}});for(var B=x=0;4>x;)f.each(u.userCardObj,function(a,b){console.log("charaModel,index:",
a,b);if(a)if(a.revision>=x){if(v[n[x]][0]){var c="userPieceId"+("00"+(B+1)).slice(-2)+(x+1),e="userPieceId"+("00"+(B+1)).slice(-2)+(x-1),h=function(b){if(v[n[x]][b]){var d=v[n[x]][b].pieceId,f;f=v[n[x]][b].piece;f=f.charaIds?-1<f.charaIds.indexOf(a.charaId)?!0:!1:!0;!f||y[e]&&y[e]===d?h(b+1|0):(u[c]=v[n[x]][b].id+"",y[c]=v[n[x]][b].pieceId,v[n[x]].splice(b,1),C[n[x]]++,B=B+1|0)}else B=B+1|0};h(0)}}else B=B+1|0}),x=x+1|0,B=0;20!==u.deckType&&(u=N(u));u=w.deckDataCreate(u);z(u,l);d.model.clear({silent:!0});
d.model.set(u);q.getBaseData(a.getNativeObj());if(a.tutorialId)a.tutorialUtil[a.tutorialId]("autoPop");a.g_popup_instance.remove()}})})}},pieceEquip:function(b){b.preventDefault();if(!a.isScrolled()&&(b.stopPropagation(),F.popupTimerStop(),!(a.detailPopup||b.currentTarget.parentNode.parentNode.classList.contains("support")&&"quest"===g)&&(b.currentTarget.classList.contains("canEquip")||b.currentTarget.classList.contains("equiped")||b.currentTarget.classList.contains("tapBlock"))&&"dungeonInMap"!==
g)){q.startSe(1002);var c=Number(b.currentTarget.parentNode.parentNode.dataset.posindex),e=Number(b.currentTarget.dataset.pieceindex),d=Number(b.currentTarget.parentNode.parentNode.dataset.charaid),h=b.currentTarget.parentNode.parentNode.dataset.charaname;b=b.currentTarget.parentNode.parentNode.dataset.charaatt;var m=this.model.toJSON().userPieceObj["place"+c]||[],k=0<m.length?m[e-1]:null,t=a.storage.userCardListEx.findWhere({charaId:d}).toJSON().revision,r={},p=this;f.each(this.model.toJSON().userPieceObj,
function(a,b){f.each(a,function(a,c){a&&a.id&&(r[a.id]={name:p.model.toJSON().userCardObj[b].chara.name,charaId:p.model.toJSON().userCardObj[b].card.miniCharaNo},p.model.toJSON().userCardObj[b].chara.title&&(r[a.id].name+=" "+p.model.toJSON().userCardObj[b].chara.title))})});a.equipInfo={charaName:h,charaId:d,charaAtt:b,posIndex:c,pieceIndex:e,pieceArr:m,pieceModel:k,allPiece:r,selectPieceId:k?k.id:null,revision:t};a.holdDeck=this.model.toJSON();location.href="#/MemoriaEquip"}},memoriaSetEquipLink:function(b){b.preventDefault();
if(!a.isScrolled()){var c=Number(b.currentTarget.parentNode.parentNode.dataset.posindex),e=Number(b.currentTarget.parentNode.parentNode.dataset.charaid),d=b.currentTarget.parentNode.parentNode.dataset.charaname;b=b.currentTarget.parentNode.parentNode.dataset.charaatt;var h=this.model.toJSON().userPieceObj["place"+c]||[],g=a.storage.userCardListEx.findWhere({charaId:e}).toJSON().revision,k={},t=this;f.each(this.model.toJSON().userPieceObj,function(a,b){f.each(a,function(a,c){a&&a.id&&(k[a.id]={name:t.model.toJSON().userCardObj[b].chara.name,
charaId:t.model.toJSON().userCardObj[b].card.miniCharaNo},t.model.toJSON().userCardObj[b].chara.title&&(k[a.id].name+=" "+t.model.toJSON().userCardObj[b].chara.title))})});a.equipInfo={charaName:d,charaId:e,charaAtt:b,posIndex:c,pieceIndex:0,pieceArr:h,pieceModel:null,allPiece:k,selectPieceId:null,revision:g};a.holdDeck=this.model.toJSON();location.href="#/MemoriaSetEquip"}},popupTimeStart:function(b){var c=this.model.toJSON(),e=c.userCardObj["place"+b.currentTarget.parentNode.dataset.posindex];if(!(a.tutorialId||
e&&e.isNpc)&&e&&e.card){var d=this;b.currentTarget.classList.contains("memoriaSkillWrap")&&(e.initTabType="memoria");a.holdDeck&&(e.linkBlock=!0);e.deckFormationFlag=!0;E.cardDetailPopup(b,e,function(){if(a.storage.userCardListEx){var b=w.deckDataCreate(c);d.model.clear({silent:!0});d.model.set(b);q.getBaseData(a.getNativeObj())}d.selectModel=null;d.selectPos=null;a.doc.querySelector("#charaListWrap").className=""})}},memoriaPopupTimeStart:function(b){var c=this.model.toJSON(),e=b.currentTarget.parentNode.parentNode.dataset.posindex,
d=b.currentTarget.dataset.pieceindex,h=c.userPieceObj["place"+e][d-1],f=c.userCardObj["place"+e];!a.tutorialId&&h&&(h=c.userPieceObj["place"+e][d-1],f.supportFlag&&"support"!==g?h.supportFlag=!0:(c=(c=a.storage.userPieceList.findWhere({id:h.id}))?c.toJSON():null,h.protect=c?c.protect:h.protect),F.cardDetailPopup(b,h))},bonusTextUpdate:function(){a.doc.querySelector("#bonusTextWrap").innerHTML="";var b=this.model.toJSON(),c={};f.each(b.userCardObj,function(a,b){a.eventEffect&&f.each(a.eventEffect,
function(a,b){b in c||(c[b]=0);c[b]+=a|0})});var e={DROPADD:"Drops"},d={DROPADD:"＋"},h={DROPADD:""};0!==Object.keys(c).length?f.each(c,function(b,c){var f=c.split("_"),g=f[0];f.shift();f=f.join("_").toLowerCase();if(!a.doc.querySelector("."+c)){var k=document.createElement("span"),m=document.createElement("span"),n=document.createElement("span"),l=document.createElement("span");k.className="bonusText "+c;m.className="bonusIcon";m.style.cssText="background:url('/magica/resource/image_web/common/icon/event/icon_"+
f+"_f.png') left top no-repeat; background-size:26px 26px;";n.className="iconText ts_gold";n.textContent=e[g];l.className="text ts_pink02";k.appendChild(m);k.appendChild(n);k.appendChild(l);a.doc.querySelector("#bonusTextWrap").appendChild(k)}b/=1E3;a.doc.querySelector("."+c+" .text").textContent=d[g]+b+h[g]}):a.doc.querySelector("#bonusTextWrap").innerHTML=""},removeView:function(){this.off();this.remove()}}),U=function(){var b=!0;"dungeonInMap"===g&&(b=!1,a.addClass(a.doc.querySelector("#charaListWrap"),
"dungeonInMap"));a.removeClass(a.doc.querySelector("#charaListElms .select"),"select");a.removeClass(a.doc.querySelector("#charaListElms .formationRemove"),"formationRemove");f.each([].slice.call(a.doc.querySelectorAll("#charaListElms .formationCurrent")),function(b){a.removeClass(b,"formationCurrent")});f.each(d.model.toJSON().userCardObj,function(c,e){c.card&&(d.selectModel&&d.selectModel.userCardId==c.userCardId?(b?a.addClass(a.doc.querySelector(".userCardId"+d.selectModel.userCardId),"formationRemove"):
a.addClass(a.doc.querySelector(".userCardId"+c.userCardId),"formationCurrent"),a.addClass(a.doc.querySelector(".userCardId"+d.selectModel.userCardId),"select")):a.addClass(a.doc.querySelector(".userCardId"+c.userCardId),"formationCurrent"))})},N=function(a){var b=f.clone(a),e=!1;f.each(b.userCardObj,function(a,c){c=Number(c.split("place")[1]);a&&a.userCardId&&a.userCardId==b.questEpisodeUserCardId&&9>=c&&(e=!0)});if(!e){var d=null;f.each(b.userCardObj,function(a,b){b=Number(b.split("place")[1]);!d&&
a&&a.card&&!a.supportFlag&&9>=b&&(d=a.userCardId)});b.questEpisodeUserCardId=d?d:void 0}return b},z=function(b,c){var e=!1;f.each(b,function(a,d){if("formationSheetId"==d||"name"==d||"questEpisodeUserCardId"==d||"questPositionHelper"==d||-1!==d.indexOf("questPositionId")||-1!==d.indexOf("userCardId")||-1!==d.indexOf("userPieceId"))e=b[d]!==c[d]?!0:e});f.each(c,function(a,d){if("formationSheetId"==d||"name"==d||"questEpisodeUserCardId"==d||"questPositionHelper"==d||-1!==d.indexOf("questPositionId")||
-1!==d.indexOf("userCardId")||-1!==d.indexOf("userPieceId"))e=b[d]!==c[d]?!0:e});d.bonusTextUpdate();if(e){a.addClass(a.doc.querySelector(".deckViewWrap"),"deckChangeBg");a.doc.querySelector("#sideMenu").className="anim"==a.doc.querySelector("#sideMenu").className?"close":"";a.androidKeyStop=!0;a.holdDeck=b;setTimeout(function(){a.addBackHandler(a.pageObj.deckChangeConf)},0);if("quest"===g||"dungeon"===g||"dungeonInMap"===g)a.addClass(a.doc.querySelector("#nextPageBtn"),"noneDisp"),a.removeClass(a.doc.querySelector("#mainBtn"),
"noneDisp");a.removeClass(a.doc.querySelector("#mainBtn"),"off")}else{a.removeClass(a.doc.querySelector(".deckViewWrap"),"deckChangeBg");a.removeBackHandler();a.androidKeyStop=!1;a.holdDeck=null;if("quest"===g||"dungeon"===g||"dungeonInMap"===g)a.removeClass(a.doc.querySelector("#nextPageBtn"),"noneDisp"),a.addClass(a.doc.querySelector("#mainBtn"),"noneDisp");a.addClass(a.doc.querySelector("#mainBtn"),"off")}d.selectModel=null;d.selectPos=null;a.removeClass(a.doc.querySelector("#charaListWrap"),"open");
return e},w;return{needModelIdObj:[{id:"user"},{id:"gameUser"},{id:"userItemList"},{id:"userStatusList"},{id:"userDeckList"},{id:"userFormationSheetList"},{id:"userPieceList"},{id:"userPieceSetList"},{id:"userCardList"},{id:"userCharaList"},{id:"userDoppelList"},{id:"userLive2dList"}],fetch:function(a){a&&(String(a).match(/TU/)?G=a:g=a);D.pageModelGet(this.needModelIdObj)},init:function(){if("TU560"==G)if(a.tutorialId=G,a.tutorialUtil)a.tutorialUtil.tutorialIdRegist(a.tutorialId),a.tutorialUtil.tutorialAddClass(a.tutorialId);
else{q.nativeReload("#/TopPage");return}Q.createCardList();C=D.getPageJson();w=new S(g);var b=w.deckPrmInit();y=b.currentDeckType;l=b.currentDeckModel;a.setStyle(P);v=new T;v.charaListView=new R({model:new H,collection:a.storage.userCardListEx});a.content.append(v.charaListView.render().el);a.scrollSetX("charaListScrollWrap","list");q.getBaseData(a.getNativeObj())},charaSelect:function(b,c){if(!c){if(a.tutorialId)a.tutorialUtil[a.tutorialId]("charaSelect");d.deckSet(null,b)}},deckChangeConf:function(b){b&&
b.type&&(b=null);var c=new a.PopupClass({canClose:!1,title:"Change Team",content:"The Team has been updated.",closeBtnText:"Cancel",decideBtnText:"Save"},null,function(){$("#popupArea .popupCloseBtn").on(a.cgti,function(){$("#popupArea .popupCloseBtn").off();var e=w.deckDataCreate(l);d.model.clear({silent:!0});d.model.set(e);z(d.model.toJSON(),l);c.remove();a.holdDeck=null;q.getBaseData(a.getNativeObj());d.selectModel=null;d.selectPos=null;a.doc.querySelector("#charaListWrap").className="";b&&b()});
$("#popupArea .decideBtn").on(a.cgti,function(){$("#popupArea .decideBtn").off();v.deckSave();c.remove();d.selectModel=null;d.selectPos=null;a.doc.querySelector("#charaListWrap").className="";b&&b()});v.deckChangeFlag=!1})},remove:function(b){v&&(a.removeBackHandler(),E.popupTimerStop(),F.popupTimerStop(),g&&"quest"!==g||(a.currentDeckType=d.model.toJSON().deckType),"dungeon"===g&&(a.currentDungeonDeckType=d.model.toJSON().deckType),v.charaListView.trigger("remove"),v.charaListView.remove(),v.trigger("removeView"),
v.remove());C=w=l=y=g=G=null;b()}}});